# v0.52 → v0.55 官方改进实现规划 📋

## 📊 概览信息

- **源版本**: v0.52 (f5c6e26) → v0.55 (2cd286c)
- **总提交数**: 18 个提交
- **文件变更**: 23 个文件 (439+ / 150- 行)
- **分析日期**: 2025-11-22

---

## 🎯 优先级分类

### 🔥 高优先级（P0）- 用户体验核心
| 编号 | 改进项 | 重要性 | 实现难度 | 预估工作量 |
|------|--------|--------|----------|-----------|
| P0-1 | 环境变量覆盖警告 | ⭐⭐⭐⭐⭐ | ⭐⭐ | 0.5天 |
| P0-2 | 流式打印修复 | ⭐⭐⭐⭐⭐ | ⭐⭐ | 0.5天 |
| P0-3 | SetTodoList Markdown样式 | ⭐⭐⭐⭐ | ⭐⭐⭐ | 1天 |
| P0-4 | 提示符显示cwd名称 | ⭐⭐⭐⭐ | ⭐ | 0.5天 |
| P0-5 | 路径缩短显示 | ⭐⭐⭐⭐ | ⭐⭐ | 0.5天 |

### 🟡 中优先级（P1）- 功能增强
| 编号 | 改进项 | 重要性 | 实现难度 | 预估工作量 |
|------|--------|--------|----------|-----------|
| P1-1 | 批准请求提示音 | ⭐⭐⭐ | ⭐ | 0.5天 |
| P1-2 | Shell模式CD警告 | ⭐⭐⭐ | ⭐⭐ | 0.5天 |
| P1-3 | Glob工具增强 | ⭐⭐⭐ | ⭐⭐ | 1天 |
| P1-4 | FetchURL优化 | ⭐⭐⭐ | ⭐⭐⭐ | 1.5天 |
| P1-5 | Windows上下文修复 | ⭐⭐⭐ | ⭐⭐⭐⭐ | 1天 |

### 🔵 低优先级（P2）- 代码质量与优化
| 编号 | 改进项 | 重要性 | 实现难度 | 预估工作量 |
|------|--------|--------|----------|-----------|
| P2-1 | 日志启用函数 | ⭐⭐ | ⭐ | 0.5天 |
| P2-2 | 绝对路径解析 | ⭐⭐ | ⭐⭐ | 0.5天 |
| P2-3 | 路径工具模块 | ⭐⭐ | ⭐⭐ | 1天 |
| P2-4 | UI可视化模块 | ⭐⭐ | ⭐⭐⭐⭐ | 2天 |
| P2-5 | MCP超时延长 | ⭐⭐ | ⭐ | 0.5天 |
| P2-6 | ACP服务器修复 | ⭐ | ⭐⭐⭐ | 1天 |
| P2-7 | 依赖版本升级 | ⭐ | ⭐ | 0.5天 |

---

## 📋 详细实现规划

### Phase 1: 用户体验核心改进（1-2天）

#### 1.1 环境变量覆盖警告 ⭐⭐⭐⭐⭐
**文件**: `my_cli/config.py` 或 `my_cli/app.py`

**实现方案**:
```python
def check_env_var_override():
    """检查并警告环境变量覆盖"""
    api_key = os.getenv("MOONSHOT_API_KEY")
    if api_key:
        console.print(
            "[yellow]⚠️[/yellow] [bold]Warning:[/bold] "
            "API key is being overridden by environment variable. "
            "Consider using config file for better security.",
            style="yellow"
        )
```

**检查点**:
- [ ] 在应用启动时调用检查函数
- [ ] 只在开发模式下显示（避免生产环境警告）
- [ ] 测试环境变量检测逻辑

**状态**: ⏳ 待实现

---

#### 1.2 流式打印修复 ⭐⭐⭐⭐⭐
**文件**: `my_cli/ui/print_ui.py`

**实现方案**:
```python
async def _handle_stream_end():
    """确保最后一条消息被正确处理"""
    # 确保所有流式数据都被消费
    if self._buffer:
        await self._flush_buffer()
```

**检查点**:
- [ ] 检查PrintUI的流式处理逻辑
- [ ] 确保消息队列完整性
- [ ] 测试长响应的完整性

**状态**: ⏳ 待实现

---

#### 1.3 SetTodoList Markdown样式 ⭐⭐⭐⭐
**文件**: `my_cli/tools/task/todo.py`

**实现方案**:
```python
def format_todo_markdown(todo_text: str) -> str:
    """格式化TODO为Markdown"""
    return f"**TODO List**:\n\n{todo_text}"

# 在render中使用
markdown = Markdown(format_todo_markdown(todo_text))
console.print(markdown)
```

**检查点**:
- [ ] 检查当前TODO实现
- [ ] 添加Markdown格式化
- [ ] 优化显示样式

**状态**: ⏳ 待实现

---

#### 1.4 提示符显示cwd名称 ⭐⭐⭐⭐
**文件**: `my_cli/ui/shell/prompt.py`

**实现方案**:
```python
def get_prompt() -> str:
    """生成带cwd名称的提示符"""
    cwd_name = Path.cwd().name
    return f"[bold cyan]{cwd_name}[/bold cyan]$ "
```

**检查点**:
- [ ] 检查现有提示符实现
- [ ] 添加cwd名称显示
- [ ] 测试不同路径的显示效果

**状态**: ⏳ 待实现

---

#### 1.5 路径缩短显示 ⭐⭐⭐⭐
**文件**: `my_cli/utils/path.py`（需新增）

**实现方案**:
```python
def shorten_path(path: Path, max_length: int = 50) -> str:
    """缩短路径显示"""
    path_str = str(path)
    if len(path_str) <= max_length:
        return path_str

    parts = path.parts
    if len(parts) <= 2:
        return path_str

    # 显示首尾两部分，中间用...
    return f"{parts[0]}/.../{parts[-1]}"
```

**检查点**:
- [ ] 创建path.py工具模块
- [ ] 实现shorten_path函数
- [ ] 在欢迎消息中使用
- [ ] 测试长路径缩短效果

**状态**: ⏳ 待实现

---

### Phase 2: 功能增强改进（3-5天）

#### 2.1 批准请求提示音 ⭐⭐⭐
**文件**: `my_cli/ui/print_ui.py` 或 `my_cli/ui/shell.py`

**实现方案**:
```python
def play_bell():
    """播放提示音"""
    print("\a", end="", flush=True)

# 在批准请求时调用
if approval_pending:
    play_bell()
    console.print("[yellow]⚠️ 待批准的操作，请查看上方消息[/yellow]")
```

**检查点**:
- [ ] 在批准逻辑中添加Bell字符
- [ ] 确保兼容性（Windows/Unix）
- [ ] 测试提示音效果

**状态**: ⏳ 待实现

---

#### 2.2 Shell模式CD警告 ⭐⭐⭐
**文件**: `my_cli/ui/shell.py`

**实现方案**:
```python
async def handle_cd_command(args: list[str]):
    """处理cd命令"""
    if args:  # 有参数
        console.print(
            "[yellow]⚠️[/yellow] "
            "Warning: cd command affects shell only. "
            "Use 'work_dir' command to change Kimi's working directory.",
            style="yellow"
        )
```

**检查点**:
- [ ] 检查Shell命令处理逻辑
- [ ] 添加cd命令检测
- [ ] 显示友好警告消息

**状态**: ⏳ 待实现

---

#### 2.3 Glob工具增强 ⭐⭐⭐
**文件**: `my_cli/tools/file/glob.py`

**实现方案**:
```python
def format_ls_style(paths: list[Path]) -> str:
    """格式化glob结果为ls风格"""
    output = []
    for path in sorted(paths):
        if path.is_dir():
            output.append(f"{path.name}/")
        else:
            output.append(path.name)
    return "\n".join(output)

# 在glob中检测'**'模式
if pattern == "**":
    return format_ls_style(paths)
```

**检查点**:
- [ ] 检查当前Glob实现
- [ ] 添加'**'模式特殊处理
- [ ] 实现ls风格格式化

**状态**: ⏳ 待实现

---

#### 2.4 FetchURL优化 ⭐⭐⭐
**文件**: `my_cli/tools/web/fetch.py`

**实现方案**:
```python
async def fetch_and_render(url: str) -> str:
    """优化txt/markdown文件的获取和渲染"""
    content = await fetch_url(url)
    content_type = detect_content_type(url, content)

    if content_type == "text/markdown":
        return render_markdown(content)
    elif content_type == "text/plain":
        return content  # 直接返回纯文本
    else:
        return content  # 默认处理
```

**检查点**:
- [ ] 检查当前FetchURL实现
- [ ] 添加内容类型检测
- [ ] 优化Markdown渲染
- [ ] 测试不同文件类型

**状态**: ⏳ 待实现

---

#### 2.5 Windows上下文修复 ⭐⭐⭐
**文件**: `my_cli/soul/context.py`

**实现方案**:
```python
async def execute_command(cmd: str):
    """确保Windows下工作目录不被修改"""
    import os
    original_cwd = os.getcwd()
    try:
        # 执行命令
        result = await run_command(cmd)
    finally:
        # 恢复工作目录
        os.chdir(original_cwd)
```

**检查点**:
- [ ] 检查当前上下文管理
- [ ] 添加工作目录保护
- [ ] 测试Windows环境

**状态**: ⏳ 待实现

---

### Phase 3: 代码质量与优化（2-3天）

#### 3.1 日志启用函数 ⭐⭐
**文件**: `my_cli/utils/logging.py` 或 `my_cli/app.py`

**实现方案**:
```python
def enable_logging(level: str = "INFO"):
    """动态启用日志记录"""
    logger.remove()  # 移除默认handler
    logger.add(
        sys.stderr,
        level=level,
        format="{time:YYYY-MM-DD HH:mm:ss} | {level} | {message}"
    )
```

**检查点**:
- [ ] 添加enable_logging函数
- [ ] 配置loguru
- [ ] 在应用启动时调用

**状态**: ⏳ 待实现

---

#### 3.2 绝对路径解析 ⭐⭐
**文件**: `my_cli/agentspec.py`

**实现方案**:
```python
def resolve_agent_path(path: str) -> Path:
    """解析agent文件路径为绝对路径"""
    return Path(path).resolve()
```

**检查点**:
- [ ] 检查agent spec加载逻辑
- [ ] 添加路径解析
- [ ] 测试相对路径

**状态**: ⏳ 待实现

---

#### 3.3 路径工具模块 ⭐⭐
**文件**: `my_cli/utils/path.py`

**实现方案**:
```python
from pathlib import Path

def shorten_path(path: Path, max_length: int = 50) -> str:
    """缩短路径显示"""

def normalize_path(path: str) -> str:
    """标准化路径格式"""

def get_cwd_name() -> str:
    """获取当前工作目录名称"""
```

**检查点**:
- [ ] 创建path.py模块
- [ ] 实现工具函数
- [ ] 在多个地方复用

**状态**: ⏳ 待实现

---

#### 3.4 UI可视化模块 ⭐⭐
**文件**: `my_cli/ui/visualize.py`

**实现方案**:
```python
from rich.console import Console
from rich.table import Table
from rich.progress import Progress

def render_table(data: list[dict], columns: list[str]) -> Table:
    """渲染表格"""

def render_progress(current: int, total: int) -> Progress:
    """渲染进度条"""

def render_list(items: list[str]) -> str:
    """渲染列表"""
```

**检查点**:
- [ ] 创建visualize.py模块
- [ ] 实现基础渲染函数
- [ ] 在UI中使用

**状态**: ⏳ 待实现

---

## 🗓️ 实施时间表

### Week 1: Phase 1（用户体验核心）
- **Day 1**: P0-1, P0-4, P0-5
- **Day 2**: P0-2, P0-3

### Week 2: Phase 2（功能增强）
- **Day 1**: P1-1, P1-2, P1-5
- **Day 2**: P1-3
- **Day 3**: P1-4

### Week 3: Phase 3（代码质量）
- **Day 1**: P2-1, P2-2, P2-3
- **Day 2**: P2-4
- **Day 3**: P2-5, P2-6, P2-7

### Week 4: 测试与优化
- 全面测试
- Bug修复
- 文档更新
- 性能优化

---

## 📊 总体工作量估算

| Phase | 任务数 | 总工作量 | 人力需求 |
|-------|--------|----------|----------|
| **P0** | 5个 | 3天 | 1人 |
| **P1** | 5个 | 4天 | 1人 |
| **P2** | 7个 | 5.5天 | 1人 |
| **总计** | **17个** | **12.5天** | **1人** |

---

## 🎯 关键里程碑

- [ ] **M1**: 完成Phase 1（用户体验核心）- Day 2
- [ ] **M2**: 完成Phase 2（功能增强）- Day 7
- [ ] **M3**: 完成Phase 3（代码质量）- Day 12
- [ ] **M4**: 完成测试与优化 - Day 17

---

## ⚠️ 风险评估

### 高风险项
1. **Windows上下文修复** - 跨平台兼容性复杂
2. **UI可视化模块** - 新模块设计复杂
3. **ACP服务器修复** - 协议细节不明确

### 中风险项
1. **FetchURL优化** - 涉及多个文件类型
2. **MCP超时延长** - 需要了解MCP实现

### 低风险项
1. **环境变量警告** - 简单逻辑
2. **提示符优化** - 小改动
3. **批准请求提示音** - 一行代码

---

## 📝 实施建议

1. **优先P0任务** - 直接提升用户体验
2. **先实现再优化** - 先实现核心功能，再完善细节
3. **单元测试** - 每个改进都要有测试覆盖
4. **渐进式** - 分阶段提交，便于代码审查
5. **文档同步** - 实现后及时更新文档

---

## 🔗 参考资源

- [官方改动文档](../kimi-cli-fork/docs/待了解改动/2025-11-18_sync_v0.52_to_v0.55.md)
- [Rich库文档](https://rich.readthedocs.io/)
- [Python Pathlib指南](https://docs.python.org/3/library/pathlib.html)
- [MCP协议规范](https://modelcontextprotocol.io/)

---

**创建时间**: 2025-11-22
**规划制定**: 基于官方 v0.52→v0.55 改进分析
**预估工期**: 17个工作日（3-4周）

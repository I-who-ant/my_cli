# é™æ€èµ„æºç›®å½• - é…ç½®ä¸æç¤ºè¯åº“ ğŸ“š

## ğŸ¯ æ¦‚è§ˆ

é™æ€èµ„æºç›®å½•æ˜¯ Kimi CLI çš„**é…ç½®ä¸æç¤ºè¯åº“**ï¼ŒåŒ…å« Agent è§„èŒƒã€æç¤ºè¯æ¨¡æ¿ã€ç³»ç»Ÿé…ç½®æ–‡ä»¶ç­‰éä»£ç èµ„æºã€‚è¿™äº›ç›®å½•é‡‡ç”¨**å£°æ˜å¼é…ç½®**è®¾è®¡ï¼Œé€šè¿‡ YAML é…ç½®æ–‡ä»¶å®šä¹‰ Agent è¡Œä¸ºï¼Œé€šè¿‡ Markdown æ–‡ä»¶å­˜å‚¨æç¤ºè¯æ¨¡æ¿ï¼Œå®ç°å†…å®¹ä¸ä»£ç çš„å®Œå…¨åˆ†ç¦»ã€‚è¿™ç§è®¾è®¡æä¾›äº†æå¤§çš„çµæ´»æ€§ï¼Œç”¨æˆ·æ— éœ€ä¿®æ”¹ä»£ç å³å¯å®šåˆ¶ Agent è¡Œä¸ºã€‚

---

## ğŸ“‚ ç›®å½•ç»“æ„

```
my_cli/
â”œâ”€â”€ agents/                    # Agent è§„èŒƒé…ç½®
â”‚   â””â”€â”€ default/
â”‚       â”œâ”€â”€ agent.yaml         # é»˜è®¤ Agent å®šä¹‰
â”‚       â””â”€â”€ system.md          # ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿
â”œâ”€â”€ prompts/                   # æç¤ºè¯æ¨¡æ¿åº“
â”‚   â”œâ”€â”€ __init__.py            # æ¨¡æ¿åŠ è½½å™¨
â”‚   â””â”€â”€ compact.md             # Context å‹ç¼©æç¤ºè¯
â””â”€â”€ deps/                      # ä¾èµ–ç›®å½•ï¼ˆé¢„ç•™ï¼‰
```

---

## ğŸ—ï¸ è®¾è®¡ç†å¿µ

### å†…å®¹ä¸ä»£ç åˆ†ç¦»

```mermaid
graph TB
    A[é™æ€èµ„æº] --> B[YAML é…ç½®]
    A --> C[Markdown æ¨¡æ¿]
    A --> D[JSON æ•°æ®]

    B --> E[Agent å®šä¹‰]
    C --> F[ç³»ç»Ÿæç¤ºè¯]
    C --> G[å·¥å…·æè¿°]
    D --> H[å†å²è®°å½•]
```

### æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ | ä»·å€¼ |
|------|------|------|
| **å£°æ˜å¼** | ä½¿ç”¨é…ç½®æ–‡ä»¶å®šä¹‰è¡Œä¸º | æ— éœ€ç¼–ç¨‹çŸ¥è¯† |
| **ç‰ˆæœ¬æ§åˆ¶** | é…ç½®æ–‡ä»¶å¯ç‰ˆæœ¬åŒ– | è¿½è¸ªå˜æ›´å†å² |
| **å¤šç¯å¢ƒ** | ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½® | å¼€å‘/æµ‹è¯•/ç”Ÿäº§ |
| **ç”¨æˆ·å‹å¥½** | äººç±»å¯è¯»çš„æ ¼å¼ | æ˜“äºç†è§£å’Œä¿®æ”¹ |
| **åŠ¨æ€åŠ è½½** | è¿è¡Œæ—¶åŠ è½½é…ç½®æ–‡ä»¶ | è¿è¡Œæ—¶å®šåˆ¶è¡Œä¸º |

---

## ğŸ“„ ç›®å½•è¯¦è§£

### 1. `agents/default/` - Agent è§„èŒƒ

**agent.yaml - Agent å®šä¹‰**:

```yaml
version: 1
agent:
  name: "MyCLI Assistant"
  system_prompt_path: ./system.md
  system_prompt_args:
    ROLE_ADDITIONAL: ""
  tools:
    # æ–‡ä»¶æ“ä½œå·¥å…·
    - "my_cli.tools.file:ReadFile"
    - "my_cli.tools.file:WriteFile"
    - "my_cli.tools.file:Glob"
    - "my_cli.tools.file:Grep"
    - "my_cli.tools.file:StrReplaceFile"
    - "my_cli.tools.file:PatchFile"
    # å‘½ä»¤è¡Œå·¥å…·
    - "my_cli.tools.bash:Bash"
    # ç½‘ç»œå·¥å…·
    - "my_cli.tools.web:SearchWeb"
    - "my_cli.tools.web:FetchURL"
    # é«˜çº§å·¥å…·
    - "my_cli.tools.task:Task"
    - "my_cli.tools.todo:SetTodoList"
    - "my_cli.tools.think:Think"
    # - "my_cli.tools.dmail:SendDMail"  # æ—¶é—´æ—…è¡ŒåŠŸèƒ½ï¼Œæš‚ä¸å¯ç”¨
```

**ä¼˜é›…ä¹‹å¤„**:
1. **ç»“æ„åŒ–å®šä¹‰**: ä½¿ç”¨ YAML æ¸…æ™°å®šä¹‰ Agent é…ç½®
2. **å·¥å…·åˆ—è¡¨**: æ˜ç¡®åˆ—å‡ºæ‰€æœ‰å¯ç”¨å·¥å…·
3. **å¯æ‰©å±•**: å¯ä»¥è½»æ¾æ·»åŠ æˆ–ç§»é™¤å·¥å…·
4. **æ³¨é‡Šå‹å¥½**: æ³¨é‡Šè¯´æ˜æ¯ä¸ªå·¥å…·çš„ç”¨é€”
5. **ç¦ç”¨æœºåˆ¶**: é€šè¿‡æ³¨é‡Šç¦ç”¨ç‰¹å®šåŠŸèƒ½

**system.md - ç³»ç»Ÿæç¤ºè¯**:

```markdown
# MyCLI Assistant

You are MyCLI, an AI assistant that can help users with various tasks.

## Your Capabilities

You have access to a variety of tools that allow you to:

- **File Operations**: Read, write, search, and manipulate files
- **Command Execution**: Run bash commands
- **Web Search**: Search the internet and fetch web pages
- **Task Management**: Create and manage task lists
- **Thinking**: Take time to think through complex problems

## Guidelines

1. **Be helpful**: Always try to provide useful and accurate information.
2. **Be concise**: Keep your responses clear and to the point.
3. **Use tools**: When appropriate, use the available tools to complete tasks.
4. **Ask for clarification**: If you're unsure, ask the user for more information.
...
```

**ä¼˜é›…ä¹‹å¤„**:
1. **Markdown æ ¼å¼**: äººç±»å¯è¯»ï¼Œæ˜“äºç¼–è¾‘
2. **ç»“æ„æ¸…æ™°**: ä½¿ç”¨æ ‡é¢˜å’Œåˆ—è¡¨ç»„ç»‡å†…å®¹
3. **æ–‡æ¡£å®Œæ•´**: è¯¦ç»†è¯´æ˜èƒ½åŠ›å’ŒæŒ‡å—
4. **å¯å›½é™…åŒ–**: æ–‡æœ¬å†…å®¹æ˜“äºç¿»è¯‘
5. **ç‰ˆæœ¬æ§åˆ¶**: Git å¯ä»¥è·Ÿè¸ªå˜æ›´å†å²

### 2. `prompts/` - æç¤ºè¯æ¨¡æ¿åº“

**__init__.py - æ¨¡æ¿åŠ è½½å™¨**:

```python
from pathlib import Path

COMPACT = (Path(__file__).parent / "compact.md").read_text(encoding="utf-8")
```

**ä¼˜é›…ä¹‹å¤„**:
1. **ç®€å•åŠ è½½**: ç›´æ¥è¯»å–æ–‡ä»¶å†…å®¹
2. **é›†ä¸­å¯¼å‡º**: å°†æ‰€æœ‰æ¨¡æ¿é›†ä¸­å¯¼å‡º
3. **è·¯å¾„å®‰å…¨**: ä½¿ç”¨ `Path(__file__)` è·å–æ­£ç¡®è·¯å¾„
4. **UTF-8 æ”¯æŒ**: æ­£ç¡®å¤„ç†ç¼–ç 

**compact.md - Context å‹ç¼©æç¤ºè¯**:

```markdown
# Context Compression Prompt

You are an AI assistant tasked with compressing a conversation context while preserving the most important information.

Given a conversation history, you need to:

1. **Identify Key Information**:
   - User's original request
   - Important decisions made
   - Critical information learned
   - Actions taken

2. **Remove Redundant Information**:
   - Duplicate questions and answers
   - Unnecessary details
   - Intermediate reasoning steps

3. **Summarize Effectively**:
   - Keep the context concise
   - Preserve important facts
   - Maintain logical flow

4. **Output Format**:
   - Use clear, concise language
   - Organize information logically
   - Include only essential details

Please compress the following conversation context...
```

**ä¼˜é›…ä¹‹å¤„**:
1. **ä»»åŠ¡è¯´æ˜**: è¯¦ç»†è¯´æ˜å‹ç¼©ä»»åŠ¡çš„è¦æ±‚
2. **æ­¥éª¤æ¸…æ™°**: åˆ†æ­¥éª¤è¯´æ˜å¤„ç†æµç¨‹
3. **æ ¼å¼è§„èŒƒ**: æŒ‡å®šè¾“å‡ºæ ¼å¼è¦æ±‚
4. **ä¸Šä¸‹æ–‡ä¸°å¯Œ**: æä¾›è¶³å¤Ÿçš„ä¿¡æ¯ä¾› LLM ç†è§£
5. **æ¨¡å—åŒ–**: ç‹¬ç«‹çš„æç¤ºè¯ï¼Œæ˜“äºç»´æŠ¤

### 3. `deps/` - ä¾èµ–ç›®å½•ï¼ˆé¢„ç•™ï¼‰

**å½“å‰çŠ¶æ€**: ç©ºç›®å½•

**è®¾è®¡æ„å›¾**:
- ç”¨äºæœªæ¥å­˜å‚¨å¤–éƒ¨ä¾èµ–
- å¯ä»¥å­˜æ”¾ç¬¬ä¸‰æ–¹åº“æˆ–é…ç½®
- ä¸ºæœªæ¥æ‰©å±•é¢„ç•™ç©ºé—´

**ä¼˜é›…ä¹‹å¤„**:
1. **ç»“æ„é¢„ç•™**: ä¸ºæœªæ¥åŠŸèƒ½é¢„ç•™ç›®å½•ç»“æ„
2. **ä¸å¼ºåˆ¶**: ä¸å¼ºåˆ¶ä½¿ç”¨ï¼Œä¿æŒçµæ´»æ€§
3. **æ˜“äºç†è§£**: ç›®å½•åæ¸…æ™°è¡¨æ˜ç”¨é€”

---

## ğŸŒŸ è®¾è®¡ä¼˜é›…ä¹‹å¤„

### 1. å£°æ˜å¼é…ç½®

**YAML é…ç½®æ–‡ä»¶**:

```yaml
agent:
  name: "MyCLI Assistant"
  system_prompt_path: ./system.md
  tools:
    - "my_cli.tools.file:ReadFile"
    - "my_cli.tools.bash:Bash"
```

**ä¼˜åŠ¿**:
- âœ… **äººç±»å¯è¯»**: YAML æ ¼å¼æ¸…æ™°æ˜“æ‡‚
- âœ… **ç»“æ„åŒ–**: å±‚æ¬¡åˆ†æ˜çš„æ•°æ®ç»“æ„
- âœ… **æ˜“äºç¼–è¾‘**: å¯ä»¥ä½¿ç”¨ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨
- âœ… **ç‰ˆæœ¬æ§åˆ¶**: Git å®Œç¾è·Ÿè¸ªå˜æ›´
- âœ… **æ— ä»£ç **: ä¸éœ€è¦ç¼–ç¨‹çŸ¥è¯†

### 2. æ¨¡æ¿ä¸å†…å®¹åˆ†ç¦»

**Markdown æ¨¡æ¿**:

```markdown
# System Prompt

You are an AI assistant that can help users with various tasks.

## Your Capabilities

You have access to a variety of tools...
```

**ä¼˜åŠ¿**:
- âœ… **å†…å®¹åˆ†ç¦»**: æç¤ºè¯ä¸ä»£ç å®Œå…¨åˆ†ç¦»
- âœ… **æ˜“äºç»´æŠ¤**: ä¿®æ”¹æç¤ºè¯æ— éœ€ä¿®æ”¹ä»£ç 
- âœ… **å›½é™…åŒ–å‹å¥½**: æ–‡æœ¬å†…å®¹æ˜“äºç¿»è¯‘
- âœ… **ç‰ˆæœ¬æ§åˆ¶**: è·Ÿè¸ªæç¤ºè¯å˜æ›´å†å²
- âœ… **åä½œå‹å¥½**: éå¼€å‘è€…å¯ä»¥ç¼–è¾‘æç¤ºè¯

### 3. è¿è¡Œæ—¶åŠ¨æ€åŠ è½½

**åŠ è½½æµç¨‹**:

```python
# 1. è¯»å– YAML é…ç½®
with open("agent.yaml") as f:
    config = yaml.safe_load(f)

# 2. åŠ è½½ç³»ç»Ÿæç¤ºè¯
system_prompt = Path(config["system_prompt_path"]).read_text()

# 3. åŠ¨æ€åŠ è½½å·¥å…·
for tool_path in config["tools"]:
    module_name, class_name = tool_path.rsplit(":", 1)
    module = importlib.import_module(module_name)
    tool_class = getattr(module, class_name)
    toolset += tool_class()
```

**ä¼˜åŠ¿**:
- âœ… **åŠ¨æ€é…ç½®**: è¿è¡Œæ—¶åŠ è½½ä¸åŒé…ç½®
- âœ… **å¤š Agent**: æ”¯æŒå¤šä¸ª Agent é…ç½®æ–‡ä»¶
- âœ… **çƒ­æ›´æ–°**: æ— éœ€é‡å¯å³å¯æ›´æ–°é…ç½®
- âœ… **å®‰å…¨åŠ è½½**: éªŒè¯é…ç½®æ­£ç¡®æ€§

### 4. æ¨¡å—åŒ–ç»„ç»‡

**ç›®å½•ç»“æ„**:

```
agents/
â”œâ”€â”€ default/
â”‚   â”œâ”€â”€ agent.yaml
â”‚   â””â”€â”€ system.md
â”œâ”€â”€ developer/
â”‚   â”œâ”€â”€ agent.yaml
â”‚   â””â”€â”€ system.md
â””â”€â”€ researcher/
    â”œâ”€â”€ agent.yaml
    â””â”€â”€ system.md
```

**ä¼˜åŠ¿**:
- âœ… **å¤šè§’è‰²**: ä¸ºä¸åŒè§’è‰²åˆ›å»ºä¸åŒ Agent
- âœ… **æ˜“äºç®¡ç†**: æ¯ä¸ª Agent æœ‰ç‹¬ç«‹çš„ç›®å½•
- âœ… **å¯å¤ç”¨**: å¯ä»¥åœ¨ä¸åŒé¡¹ç›®ä¸­å¤ç”¨
- âœ… **æ¸…æ™°å‘½å**: ç›®å½•åæ¸…æ™°è¡¨æ˜ç”¨é€”

### 5. æ³¨é‡Šå’Œæ–‡æ¡£

**å¸¦æ³¨é‡Šçš„é…ç½®**:

```yaml
tools:
    # æ–‡ä»¶æ“ä½œå·¥å…·
    - "my_cli.tools.file:ReadFile"
    - "my_cli.tools.file:WriteFile"
    # å‘½ä»¤è¡Œå·¥å…·
    - "my_cli.tools.bash:Bash"
    # - "my_cli.tools.dmail:SendDMail"  # æ—¶é—´æ—…è¡ŒåŠŸèƒ½ï¼Œæš‚ä¸å¯ç”¨
```

**ä¼˜åŠ¿**:
- âœ… **è‡ªæ–‡æ¡£åŒ–**: é…ç½®æœ¬èº«å°±æ˜¯æ–‡æ¡£
- âœ… **ç¦ç”¨æœºåˆ¶**: é€šè¿‡æ³¨é‡Šç¦ç”¨åŠŸèƒ½
- âœ… **åˆ†ç»„æ¸…æ™°**: æ³¨é‡Šå°†å·¥å…·åˆ†ç»„
- âœ… **æ˜“äºç†è§£**: æ–°æ‰‹å¯ä»¥å¿«é€Ÿç†è§£é…ç½®

---

## ğŸ”— å¯¹å¤–æ¥å£

### æ–‡ä»¶æ¥å£ï¼ˆè¢«ä»£ç åŠ è½½ï¼‰

- **`agents/default/agent.yaml`** - è¢« `agentspec.py` åŠ è½½
- **`agents/default/system.md`** - è¢« `agent.py` è¯»å–
- **`prompts/compact.md`** - è¢« `compaction.py` ä½¿ç”¨

### é…ç½®æ¥å£ï¼ˆç”¨æˆ·ç¼–è¾‘ï¼‰

- **ä¿®æ”¹ agent.yaml** - æ”¹å˜ Agent è¡Œä¸º
- **ç¼–è¾‘ system.md** - ä¿®æ”¹ç³»ç»Ÿæç¤ºè¯
- **æ·»åŠ æ–° Agent** - åˆ›å»ºæ–°çš„ç›®å½•å’Œé…ç½®æ–‡ä»¶

---

## ğŸ“Š ä¸å®˜æ–¹å¯¹æ¯”

| ç‰¹æ€§ | å®˜æ–¹å®ç° | æˆ‘ä»¬çš„å®ç° | ä¸€è‡´æ€§ |
|------|----------|------------|--------|
| Agent é…ç½® | YAML æ ¼å¼ | YAML æ ¼å¼ | âœ… |
| ç³»ç»Ÿæç¤ºè¯ | Markdown æ¨¡æ¿ | Markdown æ¨¡æ¿ | âœ… |
| å·¥å…·åˆ—è¡¨ | å£°æ˜å¼åˆ—è¡¨ | å£°æ˜å¼åˆ—è¡¨ | âœ… |
| æ¨¡æ¿åŠ è½½ | Path.read_text() | Path.read_text() | âœ… |
| æç¤ºè¯åº“ | prompts æ¨¡å— | prompts æ¨¡å— | âœ… |
| ç‰ˆæœ¬æ§åˆ¶ | æ”¯æŒ | æ”¯æŒ | âœ… |
| å›½é™…åŒ– | æ–‡æœ¬åˆ†ç¦» | æ–‡æœ¬åˆ†ç¦» | âœ… |
| æ³¨é‡Šæ”¯æŒ | å®Œæ•´æ³¨é‡Š | å®Œæ•´æ³¨é‡Š | âœ… |

---

## ğŸ“ å­¦ä¹ è¦ç‚¹

1. **å£°æ˜å¼è®¾è®¡**: ä½¿ç”¨é…ç½®æ–‡ä»¶å®šä¹‰è¡Œä¸º
2. **å†…å®¹åˆ†ç¦»**: æç¤ºè¯ä¸ä»£ç å®Œå…¨åˆ†ç¦»
3. **åŠ¨æ€åŠ è½½**: è¿è¡Œæ—¶åŠ è½½é…ç½®æ–‡ä»¶
4. **æ¨¡å—åŒ–ç»„ç»‡**: æŒ‰è§’è‰²/åŠŸèƒ½ç»„ç»‡é…ç½®
5. **ç‰ˆæœ¬æ§åˆ¶**: é…ç½®æ–‡ä»¶å¯ä»¥ç‰ˆæœ¬åŒ–
6. **æ³¨é‡Šå‹å¥½**: é…ç½®æ–‡ä»¶ä¸­æ·»åŠ æ³¨é‡Š
7. **å¯å›½é™…åŒ–**: æ–‡æœ¬å†…å®¹æ˜“äºç¿»è¯‘
8. **æ— ä»£ç å®šåˆ¶**: ç”¨æˆ·æ— éœ€ç¼–ç¨‹å³å¯å®šåˆ¶

---

## ğŸš€ æ€»ç»“

é™æ€èµ„æºç›®å½•æ˜¯æ•´ä¸ªé¡¹ç›®çš„**é…ç½®ä¸å†…å®¹åº“**ï¼Œå®ƒçš„ä¼˜é›…è®¾è®¡ä½“ç°åœ¨ï¼š

1. **å£°æ˜å¼**: ä½¿ç”¨ YAML/Markdown å£°æ˜å¼é…ç½®
2. **å†…å®¹åˆ†ç¦»**: æç¤ºè¯ä¸ä»£ç å®Œå…¨åˆ†ç¦»
3. **åŠ¨æ€åŠ è½½**: è¿è¡Œæ—¶åŠ¨æ€åŠ è½½é…ç½®
4. **æ¨¡å—åŒ–**: æŒ‰è§’è‰²/åŠŸèƒ½ç»„ç»‡é…ç½®
5. **ç‰ˆæœ¬æ§åˆ¶**: é…ç½®æ–‡ä»¶å¯ä»¥ç‰ˆæœ¬åŒ–
6. **æ³¨é‡Šå‹å¥½**: é…ç½®æœ¬èº«åŒ…å«æ–‡æ¡£
7. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°çš„ Agent å’Œæç¤ºè¯
8. **ç”¨æˆ·å‹å¥½**: æ— éœ€ç¼–ç¨‹çŸ¥è¯†å³å¯å®šåˆ¶

è¿™æ˜¯æ•´ä¸ª CLI çš„é…ç½®ä¸å†…å®¹åŸºç¡€ï¼Œä¸ºç”¨æˆ·æä¾›äº†æå¤§çš„çµæ´»æ€§å’Œå¯å®šåˆ¶æ€§ã€‚

---

**åˆ›å»ºæ—¶é—´**: 2025-11-22
**åŸºäºæ–‡æ¡£**: my_cli/agents/*, my_cli/prompts/*

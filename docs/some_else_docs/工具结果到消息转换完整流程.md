# å·¥å…·ç»“æœåˆ°æ¶ˆæ¯è½¬æ¢å®Œæ•´æµç¨‹

> **ç›®æ ‡**: ç†è§£å·¥å…·æ‰§è¡Œåå¦‚ä½•è½¬æ¢å¹¶å‘é€ç»™ LLM
> **æ¶‰åŠ**: KimiSoul å¼•æ“ã€æ¶ˆæ¯å¤„ç†ã€LLM é›†æˆ
> **é˜¶æ®µ**: Stage 17 â†’ Stage 18

---

## ğŸ¯ å®Œæ•´æ•°æ®æµ

### æ ¸å¿ƒæµç¨‹å›¾

```
[å·¥å…·è°ƒç”¨] â”€â”€â”€â”€â†’ [å·¥å…·æ‰§è¡Œ] â”€â”€â”€â”€â†’ [ToolResult]
      â†“                â†“              â†“
  ç”¨æˆ·è¾“å…¥          å¼‚æ­¥æ‰§è¡Œ         è¿”å›ç»“æœ
      â†“                â†“              â†“
[kimisoul.py]    [å·¥å…·ç³»ç»Ÿ]    [tool_result_to_message()]
      â†“                â†“              â†“
  LLM ç»§ç»­        [å·¥å…·ç»“æœ] â”€â”€â”€â”€â†’ [Message]
      â†“                â†“              â†“
  ç”Ÿæˆå“åº”       [message.py]     role="tool"
      â†“                â†“              â†“
   ç»“æŸ         [ç±»å‹æ£€æŸ¥]      content=[...]
                            tool_call_id=...
```

---

## ğŸ“Š åˆ†é˜¶æ®µè¯¦ç»†åˆ†æ

### Stage 8: åŸºç¡€å®ç° (å½“å‰ç®€åŒ–ç‰ˆ)

**kimisoul.py ç®€åŒ–å®ç°**:
```python
# lines 358-371 (Stage 17 å½“å‰çŠ¶æ€)
for tr in tool_results:
    # ç®€å•å­—ç¬¦ä¸²è½¬æ¢
    if hasattr(tr.result, "output"):
        output_str = str(tr.result.output)
    else:
        output_str = str(tr.result)

    # ç›´æ¥åˆ›å»º Message
    tool_msg = Message(
        role="tool",
        content=[TextPart(text=output_str)],  # åªæ”¯æŒå­—ç¬¦ä¸²
        tool_call_id=tr.tool_call_id,
    )
    await self._context.append_message(tool_msg)
```

**ç‰¹ç‚¹**:
- âœ… ç®€å•ç›´æ¥
- âŒ æ— é”™è¯¯å¤„ç†
- âŒ æ— ç±»å‹æ£€æŸ¥
- âŒ åªæ”¯æŒå­—ç¬¦ä¸²è¾“å‡º

### Stage 17: å®Œæ•´å®ç° (message.py å·²å®Œæˆ)

**message.py å®Œæ•´å‡½æ•°**:
```python
# lines 47-79 (Stage 17 å·²å®ç°ï¼Œä½†æœªè°ƒç”¨)
def tool_result_to_message(tool_result: ToolResult) -> Message:
    """å®Œæ•´ç‰ˆæœ¬ï¼šå¤„ç†é”™è¯¯ã€å¤šæ ¼å¼è¾“å‡º"""
    if isinstance(tool_result.result, ToolError):
        # é”™è¯¯å¤„ç†
        message = tool_result.result.message
        content = [system(f"ERROR: {message}")]
        if tool_result.result.output:
            content.extend(_output_to_content_parts(tool_result.result.output))
    else:
        # æˆåŠŸå¤„ç†
        content = tool_ok_to_message_content(tool_result.result)

    return Message(
        role="tool",
        content=content,
        tool_call_id=tool_result.tool_call_id,
    )
```

**ç‰¹ç‚¹**:
- âœ… å®Œæ•´é”™è¯¯å¤„ç†
- âœ… å¤šæ ¼å¼è¾“å‡ºæ”¯æŒ (str/ContentPart/ImageURLPart)
- âœ… ç³»ç»Ÿæ¶ˆæ¯åŒ…è£…
- âš ï¸ æœªåœ¨ kimisoul.py ä¸­å®é™…è°ƒç”¨

### Stage 18: å®˜æ–¹å®ç° (å®Œæ•´é›†æˆ)

**å®˜æ–¹ kimisoul.py**:
```python
# kimisoul.py:283-292 (å®˜æ–¹ v0.52+)
from kimi_cli.soul.message import check_message, system, tool_result_to_message

# è½¬æ¢æ‰€æœ‰å·¥å…·ç»“æœ
tool_messages = [tool_result_to_message(tr) for tr in tool_results]

# æ£€æŸ¥æ¶ˆæ¯å†…å®¹æ˜¯å¦è¢« LLM æ”¯æŒ
for tm in tool_messages:
    if missing_caps := check_message(tm, self._runtime.llm.capabilities):
        logger.warning("Tool result requires unsupported capabilities: {caps}", caps=missing_caps)
        raise LLMNotSupported(self._runtime.llm, list(missing_caps))
    await self._context.append_message(tm)
```

**ç‰¹ç‚¹**:
- âœ… å®Œæ•´å‡½æ•°è°ƒç”¨
- âœ… èƒ½åŠ›æ£€æŸ¥ (LLM æ˜¯å¦æ”¯æŒ)
- âœ… å¼‚å¸¸å¤„ç†
- âœ… æ‰¹é‡è½¬æ¢

---

## ğŸ” å…³é”®å‡½æ•°è¯¦è§£

### 1. tool_result_to_message()

**åŠŸèƒ½**: å°† ToolResult è½¬æ¢ä¸º Message

**å‚æ•°**:
```python
tool_result: ToolResult
    â”œâ”€ tool_call_id: str
    â””â”€ result: ToolOk | ToolError
            â”œâ”€ message: str | None
            â””â”€ output: str | ContentPart | Sequence[ContentPart]
```

**è¿”å›**:
```python
Message
    â”œâ”€ role: "tool"
    â”œâ”€ content: list[ContentPart]
    â”‚   â”œâ”€ TextPart        # æ–‡æœ¬
    â”‚   â”œâ”€ ImageURLPart    # å›¾ç‰‡ (Stage 18)
    â”‚   â””â”€ ThinkPart       # æ€è€ƒ (Stage 18)
    â””â”€ tool_call_id: str
```

### 2. tool_ok_to_message_content()

**åŠŸèƒ½**: å¤„ç†å·¥å…·æˆåŠŸç»“æœ

```python
def tool_ok_to_message_content(result: ToolOk) -> list[ContentPart]:
    content = []
    # æ·»åŠ æ¶ˆæ¯å‰ç¼€
    if result.message:
        content.append(system(result.message))
    # å¤„ç†è¾“å‡º (æ”¯æŒå¤šç§æ ¼å¼)
    content.extend(_output_to_content_parts(result.output))
    # å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œæ·»åŠ é»˜è®¤æç¤º
    if not content:
        content.append(system("Tool output is empty."))
    return content
```

### 3. _output_to_content_parts()

**åŠŸèƒ½**: ç»Ÿä¸€å¤šç§è¾“å‡ºæ ¼å¼

```python
def _output_to_content_parts(
    output: str | ContentPart | Sequence[ContentPart],
) -> list[ContentPart]:
    match output:
        case str(text):
            # å­—ç¬¦ä¸² â†’ TextPart
            if text:
                content.append(TextPart(text=text))
        case ContentPart():
            # å·²ç»æ˜¯ ContentPart â†’ ç›´æ¥è¿”å›
            content.append(output)
        case _:
            # Sequence â†’ å±•å¼€
            content.extend(output)
    return content
```

### 4. check_message()

**åŠŸèƒ½**: æ£€æŸ¥ LLM èƒ½åŠ›æ˜¯å¦æ”¯æŒæ¶ˆæ¯å†…å®¹

```python
def check_message(
    message: Message, model_capabilities: set[ModelCapability]
) -> set[ModelCapability]:
    capabilities_needed = set()
    for part in message.content:
        if isinstance(part, ImageURLPart):
            capabilities_needed.add("image_in")      # éœ€è¦å›¾ç‰‡è¾“å…¥èƒ½åŠ›
        elif isinstance(part, ThinkPart):
            capabilities_needed.add("thinking")       # éœ€è¦æ€è€ƒèƒ½åŠ›
    return capabilities_needed - model_capabilities  # è¿”å›ç¼ºå¤±çš„èƒ½åŠ›
```

---

## ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: ç®€å•å·¥å…·è°ƒç”¨

**è¾“å…¥**:
```python
ToolResult(
    tool_call_id="call_123",
    result=ToolOk(message="æ–‡ä»¶è¯»å–æˆåŠŸ", output="Hello World")
)
```

**è½¬æ¢å**:
```python
Message(
    role="tool",
    content=[
        TextPart(text="<system>æ–‡ä»¶è¯»å–æˆåŠŸ</system>"),
        TextPart(text="Hello World")
    ],
    tool_call_id="call_123"
)
```

### ç¤ºä¾‹2: é”™è¯¯å¤„ç†

**è¾“å…¥**:
```python
ToolResult(
    tool_call_id="call_456",
    result=ToolError(message="æ–‡ä»¶ä¸å­˜åœ¨", output=None)
)
```

**è½¬æ¢å**:
```python
Message(
    role="tool",
    content=[
        TextPart(text="<system>ERROR: æ–‡ä»¶ä¸å­˜åœ¨</system>")
    ],
    tool_call_id="call_456"
)
```

### ç¤ºä¾‹3: å›¾ç‰‡è¾“å‡º (Stage 18)

**è¾“å…¥**:
```python
ToolResult(
    tool_call_id="call_789",
    result=ToolOk(message="å›¾ç‰‡ç”Ÿæˆå®Œæˆ", output=ImageURLPart(url="..."))
)
```

**æ£€æŸ¥**:
```python
# æ£€æŸ¥ LLM æ˜¯å¦æ”¯æŒå›¾ç‰‡
missing_caps = check_message(message, {"text_only"})  # è¿”å› {"image_in"}
# å¦‚æœä¸æ”¯æŒï¼ŒæŠ›å‡º LLMNotSupported å¼‚å¸¸
```

**è½¬æ¢å**:
```python
Message(
    role="tool",
    content=[
        TextPart(text="<system>å›¾ç‰‡ç”Ÿæˆå®Œæˆ</system>"),
        ImageURLPart(url="...")  # éœ€è¦ LLM æ”¯æŒ image_in
    ],
    tool_call_id="call_789"
)
```

---

## ğŸš€ Stage 18 å‡çº§è®¡åˆ’

### ä»»åŠ¡åˆ—è¡¨

- [ ] **é›†æˆå®˜æ–¹å®ç°**
  - [ ] ä¿®æ”¹ kimisoul.py:283 ä½¿ç”¨ tool_result_to_message()
  - [ ] æ›¿æ¢ lines 358-371 çš„ç®€åŒ–ç‰ˆä»£ç 

- [ ] **èƒ½åŠ›æ£€æŸ¥æœºåˆ¶**
  - [ ] å®ç° check_message() å‡½æ•°
  - [ ] æ·»åŠ  ModelCapability ç±»å‹å®šä¹‰
  - [ ] é›†æˆåˆ°å·¥å…·è°ƒç”¨æµç¨‹

- [ ] **å¤šæ ¼å¼æ”¯æŒ**
  - [ ] æ·»åŠ  ImageURLPart æ”¯æŒ
  - [ ] æ·»åŠ  ThinkPart æ”¯æŒ
  - [ ] æ›´æ–° _output_to_content_parts()

- [ ] **é”™è¯¯å¤„ç†ä¼˜åŒ–**
  - [ ] LLMNotSupported å¼‚å¸¸å¤„ç†
  - [ ] ä¼˜é›…é™çº§æœºåˆ¶
  - [ ] æ—¥å¿—è®°å½•å®Œå–„

### å®æ–½æ­¥éª¤

**ç¬¬1æ­¥: å¯¼å…¥å‡½æ•°**
```python
# kimisoul.py
from my_cli.soul.message import (
    check_message,
    system,
    tool_result_to_message,
)
```

**ç¬¬2æ­¥: æ›¿æ¢ç®€åŒ–ç‰ˆ**
```python
# kimisoul.py:358-371 (æ›¿æ¢)
# å½“å‰: ç®€åŒ–ç‰ˆå¾ªç¯
# æ–°ç‰ˆ:
if tool_results:
    # æ‰¹é‡è½¬æ¢å·¥å…·ç»“æœ
    tool_messages = [tool_result_to_message(tr) for tr in tool_results]

    # æ£€æŸ¥èƒ½åŠ›å¹¶æ·»åŠ 
    for tm in tool_messages:
        # æ£€æŸ¥ LLM æ˜¯å¦æ”¯æŒæ¶ˆæ¯å†…å®¹
        if missing_caps := check_message(tm, self._runtime.llm.capabilities):
            logger.warning(
                "Tool result message requires unsupported capabilities: {caps}",
                caps=missing_caps,
            )
            raise LLMNotSupported(self._runtime.llm, list(missing_caps))

        await self._context.append_message(tm)
```

---

## ğŸ“š æ€»ç»“

**å½“å‰çŠ¶æ€ (Stage 17)**:
- âœ… message.py æ¨¡å—å®Œæˆ (å‡½æ•°å®ç°)
- âŒ kimisoul.py æœªä½¿ç”¨ (ä»åœ¨ç®€åŒ–ç‰ˆ)
- âŒ æ— èƒ½åŠ›æ£€æŸ¥æœºåˆ¶

**ç›®æ ‡çŠ¶æ€ (Stage 18)**:
- âœ… å®Œæ•´é›†æˆå®˜æ–¹å®ç°
- âœ… æ”¯æŒå¤šæ ¼å¼è¾“å‡º
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†
- âœ… LLM èƒ½åŠ›æ£€æŸ¥

**å­¦ä¹ ä»·å€¼**:
- ç†è§£æ¶ˆæ¯è½¬æ¢çš„é‡è¦æ€§
- æŒæ¡ç±»å‹å®‰å…¨çš„æ¶ˆæ¯å¤„ç†
- å­¦ä¼šèƒ½åŠ›æ£€æŸ¥æ¨¡å¼
- ä¸ºå¤šæ¨¡æ€ LLM åšå‡†å¤‡

---

**æœ€åæ›´æ–°**: 2025-11-18
**åŸºäº**: kimi-cli-fork v0.52 å®˜æ–¹å®ç°

# Wire æœºåˆ¶æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ¯ è®¾è®¡ç›®æ ‡

Wire æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶æ˜¯ Kimi CLI æ¶æ„çš„æ ¸å¿ƒåˆ›æ–°ï¼Œæ—¨åœ¨è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

1. **è§£è€¦é—®é¢˜**ï¼šAI å¼•æ“ï¼ˆSoulï¼‰å’Œç”¨æˆ·ç•Œé¢ï¼ˆUIï¼‰ç´§è€¦åˆ
2. **æµå¼é—®é¢˜**ï¼šæ— æ³•å®ç°çœŸæ­£çš„é€å­—æµå¼è¾“å‡º
3. **æ‰©å±•é—®é¢˜**ï¼šéš¾ä»¥æ”¯æŒå¤šç§ UIï¼ˆShellã€Printã€ACPã€TUIï¼‰
4. **ä¸­æ–­é—®é¢˜**ï¼šç”¨æˆ·æ— æ³•ä¼˜é›…åœ°å–æ¶ˆé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### ä¸‰å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Application Layer                   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Shell UI â”‚         â”‚ Print UI â”‚         â”‚  ACP UI  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                    â”‚                     â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                    â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Wire Messaging Layer                    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Wire Queue (asyncio.Queue)             â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚  WireSoulSide  â†â†’  Queue  â†â†’  WireUISide           â”‚   â”‚
â”‚  â”‚   (Producer)                    (Consumer)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Soul Layer                           â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Agent   â”‚ â†â†’ â”‚ Runtime  â”‚ â†â†’ â”‚   Context    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚       â†“               â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚         kosong.generate()                  â”‚            â”‚
â”‚  â”‚         + on_message_part callback         â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®è®¾è®¡å†³ç­–

#### 1. ä¸ºä»€ä¹ˆé€‰æ‹© asyncio.Queueï¼Ÿ

**å¤‡é€‰æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ˜¯å¦é‡‡ç”¨ |
|------|------|------|----------|
| **asyncio.Queue** | å¼‚æ­¥ã€FIFOã€å†…ç½®æ”¯æŒ | ä»…é™å•è¿›ç¨‹ | âœ… é‡‡ç”¨ |
| threading.Queue | çº¿ç¨‹å®‰å…¨ | é˜»å¡ I/Oï¼Œä¸é€‚åˆ asyncio | âŒ |
| multiprocessing.Queue | è·¨è¿›ç¨‹ | åºåˆ—åŒ–å¼€é”€å¤§ï¼Œå¤æ‚åº¦é«˜ | âŒ |
| è‡ªå®šä¹‰å›è°ƒé“¾ | çµæ´» | éš¾ä»¥ç®¡ç†ã€å®¹æ˜“å†…å­˜æ³„æ¼ | âŒ |

**é€‰æ‹©ç†ç”±**ï¼š

- Kimi CLI æ˜¯å•è¿›ç¨‹åº”ç”¨ï¼Œä¸éœ€è¦è·¨è¿›ç¨‹é€šä¿¡
- asyncio.Queue æ˜¯ Python å¼‚æ­¥ç¼–ç¨‹çš„æ ‡å‡†ç»„ä»¶
- FIFO ä¿è¯æ¶ˆæ¯é¡ºåºï¼Œé€‚åˆæµå¼è¾“å‡º
- å†…ç½® `shutdown()` æ”¯æŒï¼Œæ˜“äºä¼˜é›…é€€å‡º

#### 2. ä¸ºä»€ä¹ˆä½¿ç”¨ ContextVarï¼Ÿ

**é—®é¢˜åœºæ™¯**ï¼š

```python
# kosong.generate() çš„å›è°ƒå‡½æ•°ç­¾å
on_message_part: Callable[[MessagePart], None]
```

- å›è°ƒå‡½æ•°åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼ˆæ¶ˆæ¯ç‰‡æ®µï¼‰
- æ— æ³•ç›´æ¥ä¼ é€’ Wire å¯¹è±¡
- éœ€è¦ä¸€ç§"å…¨å±€"æ–¹å¼è®¿é—® Wire

**å¤‡é€‰æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | å®ç° | é—®é¢˜ |
|------|------|------|
| **ContextVar** | `_current_wire.get()` | âœ… çº¿ç¨‹å®‰å…¨ã€ä¸Šä¸‹æ–‡éš”ç¦» |
| å…¨å±€å˜é‡ | `global _wire` | âŒ å¹¶å‘å†²çªã€ä¸å®‰å…¨ |
| é—­åŒ… | `lambda: wire_send_impl(wire, msg)` | âŒ æ— æ³•ä¼ é€’ç»™ kosong |
| å•ä¾‹æ¨¡å¼ | `Wire.get_instance()` | âŒ æµ‹è¯•å›°éš¾ã€å¹¶å‘ä¸å®‰å…¨ |

**ContextVar çš„ä¼˜åŠ¿**ï¼š

```python
# åœºæ™¯ï¼šå¤šä¸ªå¹¶å‘ Soul ä»»åŠ¡
async def test_concurrent():
    # Task 1
    wire1 = Wire()
    _current_wire.set(wire1)
    await soul1.run("é—®é¢˜1")  # wire_send() ä¼šå‘é€åˆ° wire1

    # Task 2ï¼ˆå¹¶å‘ï¼‰
    wire2 = Wire()
    _current_wire.set(wire2)
    await soul2.run("é—®é¢˜2")  # wire_send() ä¼šå‘é€åˆ° wire2

    # âœ… ä¸¤ä¸ªä»»åŠ¡äº’ä¸å¹²æ‰°ï¼
```

#### 3. ä¸ºä»€ä¹ˆåˆ†ç¦» WireSoulSide å’Œ WireUISideï¼Ÿ

**è®¾è®¡æ¨¡å¼**ï¼šæ¥å£éš”ç¦»åŸåˆ™ï¼ˆInterface Segregation Principleï¼‰

```python
# âœ… æ¥å£éš”ç¦»
class WireSoulSide:
    def send(self, msg) -> None: ...  # Soul åªèƒ½å‘é€

class WireUISide:
    async def receive(self) -> WireMessage: ...  # UI åªèƒ½æ¥æ”¶

# âŒ å¦‚æœä¸éš”ç¦»
class Wire:
    def send(self, msg) -> None: ...
    async def receive(self) -> WireMessage: ...

# é—®é¢˜ï¼šUI å±‚å¯èƒ½é”™è¯¯åœ°è°ƒç”¨ send()ï¼Œç ´åå•å‘æ•°æ®æµ
```

**ä¼˜åŠ¿**ï¼š

- **èŒè´£æ˜ç¡®**ï¼šSoul ç”Ÿäº§æ¶ˆæ¯ï¼ŒUI æ¶ˆè´¹æ¶ˆæ¯
- **é˜²æ­¢è¯¯ç”¨**ï¼šç±»å‹ç³»ç»Ÿå¼ºåˆ¶å•å‘é€šä¿¡
- **æµ‹è¯•å‹å¥½**ï¼šå¯ä»¥ mock ä¸€ä¾§è€Œä¸å½±å“å¦ä¸€ä¾§

---

## ğŸ”„ æ¶ˆæ¯æµåŠ¨è¯¦è§£

### å®Œæ•´çš„æ¶ˆæ¯æµåŠ¨è·¯å¾„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: LLM API å“åº”æµ                                      â”‚
â”‚                                                               â”‚
â”‚  Moonshot API                                                â”‚
â”‚      â†“                                                       â”‚
â”‚  Server-Sent Events (SSE) æµ                                â”‚
â”‚      â†“                                                       â”‚
â”‚  "data: {\"choices\":[{\"delta\":{\"content\":\"ä½ \"}}]}\n"  â”‚
â”‚      â†“                                                       â”‚
â”‚  kosong æ¡†æ¶è§£æ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: kosong å›è°ƒè§¦å‘                                      â”‚
â”‚                                                               â”‚
â”‚  kosong.generate() å†…éƒ¨ï¼š                                    â”‚
â”‚      for chunk in sse_stream:                                â”‚
â”‚          part = TextPart(text="ä½ ")                          â”‚
â”‚          if on_message_part:                                 â”‚
â”‚              on_message_part(part)  # â­ è°ƒç”¨ wire_send()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: wire_send() å‘é€åˆ° Wire                             â”‚
â”‚                                                               â”‚
â”‚  def wire_send(msg: WireMessage):                           â”‚
â”‚      wire = _current_wire.get()  # ä» ContextVar è·å–       â”‚
â”‚      wire.soul_side.send(msg)    # å‘é€åˆ°é˜Ÿåˆ—               â”‚
â”‚          â†“                                                   â”‚
â”‚      self._queue.put_nowait(msg) # asyncio.Queue            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Wire Queue ç¼“å†²                                      â”‚
â”‚                                                               â”‚
â”‚  asyncio.Queue å†…éƒ¨ï¼š                                        â”‚
â”‚      _queue: [TextPart("ä½ "), TextPart("å¥½"), ...]          â”‚
â”‚                                                               â”‚
â”‚  ç‰¹æ€§ï¼š                                                      â”‚
â”‚  - FIFO é¡ºåº                                                â”‚
â”‚  - å¼‚æ­¥å®‰å…¨                                                 â”‚
â”‚  - è‡ªåŠ¨é˜»å¡/å”¤é†’                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: UI Loop æ¥æ”¶æ¶ˆæ¯                                     â”‚
â”‚                                                               â”‚
â”‚  async def _ui_loop(wire_ui: WireUISide):                   â”‚
â”‚      while True:                                             â”‚
â”‚          msg = await wire_ui.receive()  # â­ é˜»å¡ç­‰å¾…       â”‚
â”‚              â†“                                               â”‚
â”‚          self._queue.get()  # asyncio.Queue                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: UI æ¸²æŸ“è¾“å‡º                                          â”‚
â”‚                                                               â”‚
â”‚  if isinstance(msg, TextPart):                               â”‚
â”‚      print(msg.text, end="", flush=True)  # "ä½ "            â”‚
â”‚                                                               â”‚
â”‚  ç»ˆç«¯æ˜¾ç¤ºï¼šä½                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
                 (ç»§ç»­å¾ªç¯)
```

### æ—¶åºå›¾

```
LLM API    kosong      wire_send    Wire Queue    UI Loop    Terminal
   â”‚          â”‚            â”‚             â”‚            â”‚          â”‚
   â”œâ”€ SSE â”€â”€â†’ â”‚            â”‚             â”‚            â”‚          â”‚
   â”‚          â”‚            â”‚             â”‚            â”‚          â”‚
   â”‚          â”œâ”€ parse â”€â”€â†’ â”‚             â”‚            â”‚          â”‚
   â”‚          â”‚            â”‚             â”‚            â”‚          â”‚
   â”‚          â”œâ”€ callback â”€â”¤             â”‚            â”‚          â”‚
   â”‚          â”‚            â”‚             â”‚            â”‚          â”‚
   â”‚          â”‚            â”œâ”€ get wire â”€â”¤            â”‚          â”‚
   â”‚          â”‚            â”‚             â”‚            â”‚          â”‚
   â”‚          â”‚            â”œâ”€â”€ send() â”€â”€â†’â”‚            â”‚          â”‚
   â”‚          â”‚            â”‚             â”‚            â”‚          â”‚
   â”‚          â”‚            â”‚             â”œâ”€ receive â”€â”¤          â”‚
   â”‚          â”‚            â”‚             â”‚            â”‚          â”‚
   â”‚          â”‚            â”‚             â”‚            â”œâ”€ print â”€â†’â”‚
   â”‚          â”‚            â”‚             â”‚            â”‚          â”‚
   â”‚          â”‚            â”‚             â”‚            â”‚          â”‚ "ä½ "
```

---

## ğŸ­ å¹¶å‘ä»»åŠ¡ç®¡ç†

### run_soul() çš„ä»»åŠ¡è°ƒåº¦

#### ä»»åŠ¡å…³ç³»å›¾

```
run_soul()
    â”‚
    â”œâ”€ wire = Wire()
    â”‚
    â”œâ”€ _current_wire.set(wire)
    â”‚
    â”œâ”€ ui_task = create_task(ui_loop_fn(wire.ui_side))
    â”‚       â”‚
    â”‚       â””â”€â†’ while True:
    â”‚               msg = await wire.ui_side.receive()
    â”‚               print(msg)
    â”‚
    â”œâ”€ soul_task = create_task(soul.run(user_input))
    â”‚       â”‚
    â”‚       â””â”€â†’ kosong.generate(..., on_message_part=wire_send)
    â”‚               â””â”€â†’ wire_send(TextPart("ä½ "))
    â”‚                       â””â”€â†’ wire.soul_side.send(...)
    â”‚
    â”œâ”€ cancel_event_task = create_task(cancel_event.wait())
    â”‚       â”‚
    â”‚       â””â”€â†’ await cancel_event.wait()  # ç­‰å¾… Ctrl+C
    â”‚
    â””â”€ await wait([soul_task, cancel_event_task], FIRST_COMPLETED)
            â”‚
            â”œâ”€ å¦‚æœ soul_task å…ˆå®Œæˆ â†’ æ­£å¸¸é€€å‡º
            â”‚
            â””â”€ å¦‚æœ cancel_event_task å…ˆå®Œæˆ â†’ å–æ¶ˆ soul_task
```

#### ä¼˜é›…é€€å‡ºæµç¨‹

```
ç”¨æˆ·æŒ‰ Ctrl+C
    â†“
cancel_event.set()
    â†“
run_soul() æ£€æµ‹åˆ° cancel_event
    â†“
soul_task.cancel()
    â†“
kosong.generate() æŠ›å‡º asyncio.CancelledError
    â†“
Soul å±‚æ¸…ç†èµ„æº
    â†“
wire.shutdown()  # å…³é—­ Wire é˜Ÿåˆ—
    â†“
UI Loop çš„ receive() æŠ›å‡º asyncio.QueueShutDown
    â†“
UI Loop é€€å‡º
    â†“
run_soul() æŠ›å‡º RunCancelled
    â†“
Print UI æ•è·å¼‚å¸¸å¹¶æ˜¾ç¤ºæç¤º
    â†“
ç¨‹åºæ­£å¸¸é€€å‡º
```

---

## ğŸ§© ç±»å‹ç³»ç»Ÿè®¾è®¡

### æ¶ˆæ¯ç±»å‹å±‚æ¬¡ç»“æ„

```python
# Python 3.12+ type è¯­æ³•
type WireMessage = Event | ApprovalRequest

type Event = ControlFlowEvent | ContentPart | ToolCall | ToolCallPart | ToolResult | SubagentEvent

type ControlFlowEvent = StepBegin | StepInterrupted | CompactionBegin | CompactionEnd | StatusUpdate
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ç±»å‹è”åˆï¼Ÿ**

1. **ç±»å‹å®‰å…¨**ï¼š
```python
# âœ… IDE å¯ä»¥æ¨æ–­ msg çš„ç±»å‹
msg = await wire.ui_side.receive()
if isinstance(msg, TextPart):
    # IDE çŸ¥é“ msg.text å­˜åœ¨
    print(msg.text)
```

2. **æ¨¡å¼åŒ¹é…**ï¼ˆPython 3.10+ï¼‰ï¼š
```python
match msg:
    case TextPart(text=text):
        print(text)
    case ToolCall(tool_name=name):
        print(f"Calling {name}")
    case StepInterrupted():
        break
```

3. **æ–‡æ¡£ä»·å€¼**ï¼š
```python
# ç±»å‹ç­¾åæ¸…æ™°è¡¨è¾¾"å¯èƒ½çš„æ¶ˆæ¯ç±»å‹"
async def receive(self) -> WireMessage: ...
```

### Pydantic BaseModel çš„åº”ç”¨

**ä¸ºä»€ä¹ˆä½¿ç”¨ Pydanticï¼Ÿ**

```python
# âœ… ä½¿ç”¨ Pydantic
class StepBegin(BaseModel):
    n: int

# è‡ªåŠ¨éªŒè¯
step = StepBegin(n=1)       # âœ…
step = StepBegin(n="1")     # âŒ ValidationError
step = StepBegin()          # âŒ ValidationError (ç¼ºå°‘ n)

# åºåˆ—åŒ–æ”¯æŒ
step.model_dump()           # {'n': 1}
step.model_dump_json()      # '{"n": 1}'
```

**ä¼˜åŠ¿**ï¼š

- **è¿è¡Œæ—¶éªŒè¯**ï¼šé˜²æ­¢é”™è¯¯çš„æ¶ˆæ¯ç±»å‹
- **JSON åºåˆ—åŒ–**ï¼šæ–¹ä¾¿ä¿å­˜å’Œä¼ è¾“ï¼ˆstream-json è¾“å‡ºæ ¼å¼ï¼‰
- **æ–‡æ¡£ç”Ÿæˆ**ï¼šå¯ä»¥è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£

---

## ğŸ”¬ æ·±å…¥ ContextVar å®ç°

### ContextVar çš„å†…éƒ¨æœºåˆ¶

```python
# ç®€åŒ–çš„ ContextVar å®ç°åŸç†
class ContextVar:
    def __init__(self, name, default=None):
        self.name = name
        self.default = default
        # æ¯ä¸ª Task æœ‰è‡ªå·±çš„å­˜å‚¨
        self._storage = {}  # {task_id: value}

    def get(self):
        task_id = asyncio.current_task().id
        return self._storage.get(task_id, self.default)

    def set(self, value):
        task_id = asyncio.current_task().id
        old_value = self._storage.get(task_id)
        self._storage[task_id] = value
        # è¿”å› token ç”¨äº reset
        return (task_id, old_value)

    def reset(self, token):
        task_id, old_value = token
        if old_value is None:
            del self._storage[task_id]
        else:
            self._storage[task_id] = old_value
```

### ä¸ºä»€ä¹ˆéœ€è¦ tokenï¼Ÿ

```python
# åœºæ™¯ï¼šåµŒå¥—è®¾ç½®
async def outer():
    wire1 = Wire()
    token1 = _current_wire.set(wire1)  # è®¾ç½®ä¸º wire1

    await inner()  # è°ƒç”¨å†…å±‚å‡½æ•°

    # å¦‚æœæ²¡æœ‰ resetï¼Œwire ä¼šæ˜¯ wire2ï¼
    _current_wire.reset(token1)  # æ¢å¤ä¸º wire1

async def inner():
    wire2 = Wire()
    token2 = _current_wire.set(wire2)  # è®¾ç½®ä¸º wire2
    # ... ä½¿ç”¨ wire2 ...
    _current_wire.reset(token2)  # æ¢å¤ä¸º wire1
```

---

## ğŸ¨ æ‰©å±•æ€§è®¾è®¡

### æ”¯æŒå¤šç§ UI

Wire æœºåˆ¶çš„æœ€å¤§ä¼˜åŠ¿æ˜¯ **Soul å’Œ UI å®Œå…¨è§£è€¦**ï¼š

```python
# Shell UIï¼ˆäº¤äº’å¼ï¼‰
async def shell_ui_loop(wire_ui: WireUISide):
    while True:
        msg = await wire_ui.receive()
        # ä½¿ç”¨ rich åº“æ¸²æŸ“
        console.print(render_message(msg))

# Print UIï¼ˆéäº¤äº’å¼ï¼‰
async def print_ui_loop(wire_ui: WireUISide):
    while True:
        msg = await wire_ui.receive()
        # ç®€å•æ‰“å°
        print(format_message(msg))

# ACP UIï¼ˆMCP åè®®æœåŠ¡å™¨ï¼‰
async def acp_ui_loop(wire_ui: WireUISide):
    while True:
        msg = await wire_ui.receive()
        # å‘é€ JSON-RPC é€šçŸ¥
        await send_notification(serialize_message(msg))
```

**å…³é”®ç‚¹**ï¼š

- Soul å±‚ **ä¸çŸ¥é“** UI æ˜¯å“ªç§ç±»å‹
- Soul å±‚ **ä¸å…³å¿ƒ** æ¶ˆæ¯å¦‚ä½•æ¸²æŸ“
- åªéœ€è¦å®ç° `UILoopFn` æ¥å£å³å¯

### æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹

```python
# Stage 6ï¼šåŸºç¡€æ¶ˆæ¯
type Event = StepBegin | StepInterrupted | ContentPart | ToolCall

# Stage 7ï¼šæ·»åŠ å·¥å…·ç»“æœ
type Event = ... | ToolResult

# Stage 8ï¼šæ·»åŠ å‹ç¼©å’ŒçŠ¶æ€
type Event = ... | CompactionBegin | CompactionEnd | StatusUpdate

# Stage 9ï¼šæ·»åŠ å­ Agent
type Event = ... | SubagentEvent
```

**æ‰©å±•æ–¹å¼**ï¼š

1. åœ¨ `message.py` å®šä¹‰æ–°æ¶ˆæ¯ç±»å‹
2. æ›´æ–° `Event` ç±»å‹è”åˆ
3. UI Loop æ·»åŠ æ–°æ¶ˆæ¯çš„å¤„ç†é€»è¾‘

**æ— éœ€ä¿®æ”¹**ï¼š

- Wire ç±»ï¼ˆé˜Ÿåˆ—æœºåˆ¶ä¸å˜ï¼‰
- wire_send() å‡½æ•°ï¼ˆä»ç„¶åªå‘é€æ¶ˆæ¯ï¼‰
- run_soul() å‡½æ•°ï¼ˆè°ƒåº¦é€»è¾‘ä¸å˜ï¼‰

---

## ğŸ“ è®¾è®¡æ¨¡å¼æ€»ç»“

### 1. ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

```
Soul å±‚ï¼ˆç”Ÿäº§è€…ï¼‰ â”€â†’ Wire Queue â”€â†’ UI å±‚ï¼ˆæ¶ˆè´¹è€…ï¼‰
```

- è§£è€¦ç”Ÿäº§å’Œæ¶ˆè´¹
- ç¼“å†²å³°å€¼æµé‡
- æ”¯æŒå¼‚æ­¥å¤„ç†

### 2. æ¥å£éš”ç¦»åŸåˆ™

```
WireSoulSideï¼ˆåªå‘é€ï¼‰ â†â†’ Queue â†â†’ WireUISideï¼ˆåªæ¥æ”¶ï¼‰
```

- é˜²æ­¢è¯¯ç”¨
- èŒè´£æ˜ç¡®
- ä¾¿äºæµ‹è¯•

### 3. ä¾èµ–æ³¨å…¥æ¨¡å¼

```python
async def run_soul(
    soul: Soul,              # âœ… æ³¨å…¥ Soul å®ä¾‹
    ui_loop_fn: UILoopFn,    # âœ… æ³¨å…¥ UI Loop å‡½æ•°
    cancel_event: Event,     # âœ… æ³¨å…¥å–æ¶ˆäº‹ä»¶
):
    # ä¸ä¾èµ–å…·ä½“å®ç°ï¼Œåªä¾èµ–æ¥å£
```

### 4. è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆå›è°ƒï¼‰

```python
kosong.generate(
    ...,
    on_message_part=wire_send,  # è§‚å¯Ÿè€…ï¼ˆå›è°ƒå‡½æ•°ï¼‰
)
```

- LLM å“åº”æµæ˜¯è¢«è§‚å¯Ÿçš„ä¸»ä½“
- `wire_send` æ˜¯è§‚å¯Ÿè€…
- æ¯æ¬¡æœ‰æ–°æ¶ˆæ¯å°±é€šçŸ¥è§‚å¯Ÿè€…

---

## ğŸš€ æ€§èƒ½è€ƒè™‘

### asyncio.Queue çš„æ€§èƒ½ç‰¹æ€§

- **å†…å­˜å¼€é”€**ï¼šæ¯æ¡æ¶ˆæ¯å ç”¨ä¸€ä¸ªé˜Ÿåˆ—æ§½ä½
- **ç¼“å†²å®¹é‡**ï¼šé»˜è®¤æ— é™åˆ¶ï¼ˆå¯èƒ½å¯¼è‡´å†…å­˜é—®é¢˜ï¼‰
- **å»ºè®®**ï¼šç”Ÿäº§ç¯å¢ƒåº”è®¾ç½® `maxsize` é™åˆ¶

```python
# æ”¹è¿›å»ºè®®ï¼ˆStage 8+ï¼‰
self._queue = asyncio.Queue[WireMessage](maxsize=1000)
```

### æ¶ˆæ¯åºåˆ—åŒ–å¼€é”€

**Stage 6**ï¼šä¸åºåˆ—åŒ–ï¼Œç›´æ¥ä¼ é€’ Python å¯¹è±¡

```python
# âœ… é›¶åºåˆ—åŒ–å¼€é”€
wire.soul_side.send(TextPart(text="ä½ å¥½"))
```

**å¦‚æœæ”¹ä¸ºè·¨è¿›ç¨‹**ï¼ˆmultiprocessing.Queueï¼‰ï¼š

```python
# âŒ éœ€è¦åºåˆ—åŒ–
import pickle
data = pickle.dumps(TextPart(text="ä½ å¥½"))  # åºåˆ—åŒ–
wire.send(data)
msg = pickle.loads(data)  # ååºåˆ—åŒ–
```

**ä¸ºä»€ä¹ˆä¸è·¨è¿›ç¨‹ï¼Ÿ**

- Kimi CLI æ˜¯å•è¿›ç¨‹åº”ç”¨
- è·¨è¿›ç¨‹é€šä¿¡å¼€é”€å¤§ï¼ˆåºåˆ—åŒ– + IPCï¼‰
- asyncio å•è¿›ç¨‹å·²è¶³å¤Ÿé«˜æ•ˆ

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨ UI å±‚è°ƒç”¨ soul.run()ï¼Ÿ

**A**ï¼šå› ä¸ºéœ€è¦æ”¯æŒæµå¼è¾“å‡ºå’Œç”¨æˆ·ä¸­æ–­ã€‚

```python
# âŒ ç›´æ¥è°ƒç”¨
async for chunk in soul.run(command):
    print(chunk)  # æ— æ³•ä¸­æ–­ï¼Œæ— æ³•æµå¼

# âœ… ä½¿ç”¨ Wire
await run_soul(soul, command, ui_loop, cancel_event)
# - å¯ä»¥ä¸­æ–­ï¼ˆcancel_eventï¼‰
# - çœŸæ­£çš„æµå¼ï¼ˆon_message_partï¼‰
```

### Q2ï¼šContextVar å’Œå…¨å±€å˜é‡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A**ï¼šContextVar æ˜¯ä¸Šä¸‹æ–‡éš”ç¦»çš„ï¼Œå…¨å±€å˜é‡ä¸æ˜¯ã€‚

```python
# å…¨å±€å˜é‡ï¼ˆä¸å®‰å…¨ï¼‰
_wire = None

async def task1():
    global _wire
    _wire = Wire()  # âŒ è¦†ç›–äº† task2 çš„ wire
    await soul.run()

async def task2():
    global _wire
    _wire = Wire()
    await soul.run()

# ContextVarï¼ˆå®‰å…¨ï¼‰
_current_wire = ContextVar("wire")

async def task1():
    _current_wire.set(Wire())  # âœ… task1 çš„ä¸Šä¸‹æ–‡
    await soul.run()

async def task2():
    _current_wire.set(Wire())  # âœ… task2 çš„ä¸Šä¸‹æ–‡ï¼ˆç‹¬ç«‹ï¼‰
    await soul.run()
```

### Q3ï¼šå¦‚æœ UI Loop å¡ä½äº†æ€ä¹ˆåŠï¼Ÿ

**A**ï¼š`run_soul()` æœ‰è¶…æ—¶æœºåˆ¶ã€‚

```python
try:
    await asyncio.wait_for(ui_task, timeout=0.5)
except TimeoutError:
    # UI Loop è¶…æ—¶ï¼Œå¼ºåˆ¶é€€å‡º
    pass
```

### Q4ï¼šæ¶ˆæ¯é¡ºåºä¼šä¹±å—ï¼Ÿ

**A**ï¼šä¸ä¼šï¼Œasyncio.Queue ä¿è¯ FIFOã€‚

```python
wire.soul_side.send(TextPart("ä½ "))  # ç¬¬ 1 æ¡
wire.soul_side.send(TextPart("å¥½"))  # ç¬¬ 2 æ¡

msg1 = await wire.ui_side.receive()  # "ä½ "
msg2 = await wire.ui_side.receive()  # "å¥½"
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **asyncio å®˜æ–¹æ–‡æ¡£**ï¼šhttps://docs.python.org/3/library/asyncio.html
- **ContextVar å®˜æ–¹æ–‡æ¡£**ï¼šhttps://docs.python.org/3/library/contextvars.html
- **Pydantic æ–‡æ¡£**ï¼šhttps://docs.pydantic.dev/
- **å®˜æ–¹ kimi-cli æºç **ï¼š`kimi-cli-fork/src/kimi_cli/wire/`

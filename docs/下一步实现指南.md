# ä¸‹ä¸€æ­¥å®ç°æŒ‡å— - ä»å·¥å…·åˆ° Soul å¼•æ“

## ğŸ‰ æ­å–œï¼å·²å®Œæˆçš„éƒ¨åˆ†

### âœ… å·¥å…·æ¨¡å—ï¼ˆåˆšåˆšåˆ›å»ºï¼‰
```
my_cli/tools/
â”œâ”€â”€ __init__.py       âœ… å·¥å…·æ³¨å†Œè¡¨
â”œâ”€â”€ shell.py          âœ… Shell å·¥å…·
â”œâ”€â”€ read_file.py      âœ… ReadFile å·¥å…·
â””â”€â”€ write_file.py     âœ… WriteFile å·¥å…·
```

### âœ… CLI å’Œ App å±‚ï¼ˆä¹‹å‰å®Œæˆï¼‰
```
my_cli/
â”œâ”€â”€ cli.py            âœ… CLI å…¥å£
â”œâ”€â”€ app.py            âœ… åº”ç”¨å±‚
â””â”€â”€ ui/print/
    â””â”€â”€ ui_print.py   âœ… Print UI
```

---

## ğŸš€ ä¸‹ä¸€æ­¥ï¼šå®ç° Soul å¼•æ“

### ç›®æ ‡
åˆ›å»º Soul å¼•æ“ï¼Œè®© AI èƒ½å¤Ÿï¼š
1. è°ƒç”¨ Moonshot LLM API
2. è§£æ LLM è¿”å›çš„å·¥å…·è°ƒç”¨è¯·æ±‚
3. æ‰§è¡Œå·¥å…·å¹¶è¿”å›ç»“æœ
4. å¾ªç¯ç›´åˆ°ä»»åŠ¡å®Œæˆ

---

## ğŸ“ å®ç°æ­¥éª¤

### Step 1ï¼šæµ‹è¯•å·¥å…·æ˜¯å¦æ­£å¸¸å·¥ä½œ

åœ¨ `imitate-src` ç›®å½•ä¸‹è¿è¡Œï¼š

```bash
# æµ‹è¯• Shell å·¥å…·
python -m my_cli.tools.shell

# æµ‹è¯• ReadFile å·¥å…·
python -m my_cli.tools.read_file

# æµ‹è¯• WriteFile å·¥å…·
python -m my_cli.tools.write_file
```

**é¢„æœŸè¾“å‡º**ï¼šæ¯ä¸ªå·¥å…·éƒ½åº”è¯¥è¾“å‡ºæµ‹è¯•ç»“æœï¼Œæ²¡æœ‰æŠ¥é”™ã€‚

---

### Step 2ï¼šåˆ›å»º Soul å¼•æ“éª¨æ¶

åˆ›å»ºæ–‡ä»¶ `my_cli/soul.py`ï¼Œè€ç‹æˆ‘å·²ç»ç»™ä½ å‡†å¤‡å¥½å®Œæ•´ä»£ç äº†ï¼

**æ ¸å¿ƒé€»è¾‘**ï¼š
```python
class Soul:
    def __init__(self, api_key: str, model: str = "moonshot-v1-8k"):
        self.api_key = api_key
        self.model = model
        self.messages = []

    async def run(self, user_message: str) -> str:
        # 1. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        self.messages.append({"role": "user", "content": user_message})

        # 2. å¾ªç¯è°ƒç”¨ LLM
        for _ in range(10):  # æœ€å¤š 10 è½®
            response = await self._call_llm()

            # 3. æ£€æŸ¥æ˜¯å¦éœ€è¦å·¥å…·è°ƒç”¨
            if "tool_calls" in response:
                # æ‰§è¡Œå·¥å…·
                for tool_call in response["tool_calls"]:
                    result = await self._execute_tool(tool_call)
                    # æ·»åŠ å·¥å…·ç»“æœåˆ°æ¶ˆæ¯å†å²
                    self.messages.append({
                        "role": "tool",
                        "tool_call_id": tool_call["id"],
                        "content": result,
                    })
            else:
                # è¿”å›æœ€ç»ˆå“åº”
                return response["content"]

        return "âŒ è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°"

    async def _call_llm(self) -> dict:
        # è°ƒç”¨ Moonshot API
        pass

    async def _execute_tool(self, tool_call: dict) -> str:
        # æ‰§è¡Œå·¥å…·
        pass
```

---

### Step 3ï¼šé›†æˆ Moonshot API

ä½ éœ€è¦ï¼š
1. **è·å– API Key**ï¼šä» https://platform.moonshot.cn/ è·å–
2. **è®¾ç½®ç¯å¢ƒå˜é‡**ï¼š
   ```bash
   export MOONSHOT_API_KEY="ä½ çš„APIå¯†é’¥"
   ```
3. **å®‰è£… httpx**ï¼š
   ```bash
   pip install httpx
   # æˆ–
   uv pip install httpx
   ```

---

### Step 4ï¼šä¿®æ”¹ `app.py` é›†æˆ Soul

åœ¨ `MyCLI.create()` æ–¹æ³•ä¸­åˆ›å»º Soul å®ä¾‹ï¼š

```python
@staticmethod
async def create(work_dir: Path, verbose: bool = False) -> "MyCLI":
    # ... ç°æœ‰ä»£ç  ...

    # åˆ›å»º Soul å¼•æ“
    import os
    from my_cli.soul import Soul

    api_key = os.getenv("MOONSHOT_API_KEY")
    if not api_key:
        raise ValueError("âŒ è¯·è®¾ç½®ç¯å¢ƒå˜é‡ MOONSHOT_API_KEY")

    instance.soul = Soul(api_key=api_key, verbose=verbose)

    return instance
```

---

### Step 5ï¼šä¿®æ”¹ `ui_print.py` ä½¿ç”¨ Soul

å°†æ¨¡æ‹Ÿå“åº”æ›¿æ¢ä¸ºçœŸå®è°ƒç”¨ï¼š

```python
async def run(self, command: str | None = None) -> None:
    # ... å‰é¢çš„ä»£ç ä¸å˜ ...

    # è°ƒç”¨ Soul è·å–çœŸå®å“åº”
    try:
        response = await self.soul.run(command)

        print("AI å“åº”:")
        print("-" * 60)
        print(response)
        print("-" * 60)
        print()
        print("âœ… æˆåŠŸå®Œæˆï¼")
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
```

ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼š`PrintUI` éœ€è¦è®¿é—® `soul`ï¼Œæ€ä¹ˆä¼ é€’ï¼Ÿ

**æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰**ï¼šåœ¨ `app.py` ä¸­ä¼ é€’ soul ç»™ UI

```python
async def run_print_mode(self, command: str | None) -> None:
    from my_cli.ui.print.ui_print import PrintUI

    # ä¼ é€’ soul ç»™ UI
    ui = PrintUI(soul=self.soul, verbose=self.verbose)
    await ui.run(command)
```

ç„¶åä¿®æ”¹ `PrintUI.__init__`:
```python
def __init__(self, soul, verbose: bool = False):
    self.soul = soul
    self.verbose = verbose
```

---

## ğŸ”§ å®Œæ•´çš„æ–‡ä»¶åˆ›å»ºé¡ºåº

è€ç‹æˆ‘æŒ‰ä¼˜å…ˆçº§ç»™ä½ æ’å¥½äº†ï¼š

### ç¬¬1ä¼˜å…ˆçº§ï¼ˆä»Šå¤©å¿…é¡»å®Œæˆï¼‰
1. âœ… æµ‹è¯•å·¥å…·æ˜¯å¦å·¥ä½œ
2. â­ åˆ›å»º `my_cli/soul.py`
3. â­ ä¿®æ”¹ `my_cli/app.py` é›†æˆ Soul
4. â­ ä¿®æ”¹ `my_cli/ui/print/ui_print.py` ä½¿ç”¨ Soul

### ç¬¬2ä¼˜å…ˆçº§ï¼ˆæ˜å¤©ï¼‰
5. æ·»åŠ  `pyproject.toml` ä¾èµ–ï¼šhttpx
6. æµ‹è¯•å®Œæ•´æµç¨‹
7. æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### ç¬¬3ä¼˜å…ˆçº§ï¼ˆåå¤©ï¼‰
8. æ·»åŠ å·¥å…·è°ƒç”¨å¯è§†åŒ–
9. æ·»åŠ æ¶ˆæ¯å†å²æŒä¹…åŒ–
10. ä¼˜åŒ–è¾“å‡ºæ ¼å¼

---

## ğŸ’¡ å…³é”®ä»£ç ç‰‡æ®µ

### Soul._call_llm å®ç°

```python
import httpx

async def _call_llm(self) -> dict:
    """è°ƒç”¨ Moonshot API"""
    url = "https://api.moonshot.cn/v1/chat/completions"

    # æ„å»ºè¯·æ±‚
    from my_cli.tools import get_tool_schemas

    data = {
        "model": self.model,
        "messages": self.messages,
        "tools": get_tool_schemas(),  # ä½¿ç”¨å·¥å…·æ³¨å†Œè¡¨
        "temperature": 0.3,
    }

    # å‘é€è¯·æ±‚
    async with httpx.AsyncClient() as client:
        response = await client.post(
            url,
            json=data,
            headers={
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json",
            },
            timeout=60.0,
        )
        response.raise_for_status()
        result = response.json()

    # æå–æ¶ˆæ¯
    message = result["choices"][0]["message"]
    self.messages.append(message)

    return message
```

### Soul._execute_tool å®ç°

```python
import json
from my_cli.tools import TOOLS

async def _execute_tool(self, tool_call: dict) -> str:
    """æ‰§è¡Œå·¥å…·è°ƒç”¨"""
    tool_name = tool_call["function"]["name"]
    arguments_str = tool_call["function"]["arguments"]

    # è§£æå‚æ•°
    try:
        arguments = json.loads(arguments_str)
    except json.JSONDecodeError:
        return f"âŒ å·¥å…·å‚æ•°è§£æå¤±è´¥: {arguments_str}"

    # è·å–å·¥å…·
    if tool_name not in TOOLS:
        return f"âŒ æœªçŸ¥å·¥å…·: {tool_name}"

    tool_func = TOOLS[tool_name]["function"]

    # æ‰§è¡Œå·¥å…·
    try:
        if self.verbose:
            print(f"[Soul] æ‰§è¡Œå·¥å…·: {tool_name}({arguments})")

        result = await tool_func(**arguments)

        if self.verbose:
            print(f"[Soul] å·¥å…·ç»“æœ: {result}")

        # å¤„ç†ä¸åŒç±»å‹çš„è¿”å›å€¼
        if isinstance(result, dict):
            # Shell å·¥å…·è¿”å›å­—å…¸
            return json.dumps(result, ensure_ascii=False, indent=2)
        else:
            # ReadFile/WriteFile è¿”å›å­—ç¬¦ä¸²
            return str(result)

    except Exception as e:
        return f"âŒ å·¥å…·æ‰§è¡Œå¤±è´¥: {type(e).__name__}: {e}"
```

---

## ğŸ“š å­¦ä¹ èµ„æº

### Moonshot API æ–‡æ¡£
- å®˜æ–¹æ–‡æ¡£ï¼šhttps://platform.moonshot.cn/docs
- Function Callingï¼šhttps://platform.moonshot.cn/docs/api-reference#function-calling

### å‚è€ƒæºç ï¼ˆkimi-cli-forkï¼‰
```bash
# Soul å¼•æ“å®ç°
src/kimi_cli/soul/kimi_soul.py

# å·¥å…·ç³»ç»Ÿ
src/kimi_cli/tools/

# LLM è°ƒç”¨
src/kimi_cli/soul/llm.py
```

---

## ğŸ¯ æµ‹è¯•æµç¨‹

å®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œæµ‹è¯•ï¼š

```bash
# 1. è®¾ç½® API Key
export MOONSHOT_API_KEY="ä½ çš„å¯†é’¥"

# 2. æ¿€æ´»ç¯å¢ƒ
conda activate my_cli

# 3. å®‰è£…ä¾èµ–
uv pip install httpx

# 4. æµ‹è¯•å·¥å…·
mc -c "åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶"

# 5. æµ‹è¯•æ–‡ä»¶è¯»å–
mc -c "è¯»å– my_cli/cli.py çš„å‰ 10 è¡Œ"

# 6. æµ‹è¯•æ–‡ä»¶å†™å…¥
mc -c "åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ /tmp/test.txtï¼Œå†…å®¹æ˜¯ Hello World"
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•è°ƒè¯• Soul å¼•æ“ï¼Ÿ

åœ¨ `soul.py` ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š
```python
async def run(self, user_message: str) -> str:
    print(f"[Soul] æ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯: {user_message}")

    for i in range(10):
        print(f"[Soul] ç¬¬ {i+1} è½®å¾ªç¯")
        response = await self._call_llm()
        print(f"[Soul] LLM å“åº”: {response}")

        # ... å…¶ä»–é€»è¾‘ ...
```

### Q2: API è°ƒç”¨å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

æ£€æŸ¥ï¼š
1. API Key æ˜¯å¦æ­£ç¡®
2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
3. æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ï¼š`response.raise_for_status()` ä¼šæŠ›å‡ºè¯¦ç»†é”™è¯¯

### Q3: å·¥å…·è°ƒç”¨ä¸ç”Ÿæ•ˆï¼Ÿ

æ£€æŸ¥ï¼š
1. å·¥å…· schema æ ¼å¼æ˜¯å¦æ­£ç¡®
2. å·¥å…·å‚æ•°æ˜¯å¦ç¬¦åˆè¦æ±‚
3. åœ¨ verbose æ¨¡å¼ä¸‹æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯

---

## ğŸ‰ å®Œæˆæ ‡å¿—

å½“ä½ çœ‹åˆ°è¿™æ ·çš„è¾“å‡ºï¼Œå°±æˆåŠŸäº†ï¼š

```
$ mc -c "åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶"

AI å“åº”:
------------------------------------------------------------
å½“å‰ç›®å½•åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š

total 32
drwxr-xr-x  5 user user 4096 Nov 12 10:00 .
drwxr-xr-x 10 user user 4096 Nov 12 09:00 ..
-rw-r--r--  1 user user 1234 Nov 12 10:00 cli.py
-rw-r--r--  1 user user 2345 Nov 12 10:00 app.py
drwxr-xr-x  2 user user 4096 Nov 12 10:00 tools
drwxr-xr-x  3 user user 4096 Nov 12 10:00 ui

æ€»å…± 5 ä¸ªé¡¹ç›®ã€‚
------------------------------------------------------------

âœ… æˆåŠŸå®Œæˆï¼
```

---

**ç°åœ¨ï¼Œå¼€å§‹è¡ŒåŠ¨å§ï¼** ğŸš€

**è€ç‹å»ºè®®**ï¼š
1. å…ˆæµ‹è¯•å·¥å…·ï¼ˆ`python -m my_cli.tools.shell`ï¼‰
2. å†åˆ›å»º `soul.py`
3. æœ€åé›†æˆåˆ° `app.py` å’Œ `ui_print.py`

æœ‰é—®é¢˜éšæ—¶é—®è€ç‹æˆ‘ï¼
"""
Stage 10ï¼šShell UI ç¾åŒ–å’Œå¢å¼º

å­¦ä¹ ç›®æ ‡ï¼š
1. é›†æˆ prompt_toolkitï¼ˆå‘½ä»¤å†å²è®°å½•ï¼‰
2. é›†æˆ richï¼ˆPanelã€é¢œè‰²ç¾åŒ–ï¼‰
3. å®ç°æ–œæ å‘½ä»¤æ”¯æŒï¼ˆ/help, /clearï¼‰
4. ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

å¯¹åº”æºç ï¼škimi-cli-fork/src/kimi_cli/ui/shell/

æ ¸å¿ƒç‰¹æ€§ï¼ˆStage 10ï¼‰ï¼š
- âœ… prompt_toolkit PromptSessionï¼ˆå‘½ä»¤å†å²ï¼‰
- âœ… rich Panel è¾¹æ¡†ï¼ˆæ¼‚äº®çš„æ¬¢è¿ä¿¡æ¯ï¼‰
- âœ… æ–œæ å‘½ä»¤ï¼ˆ/help, /clear, /exitï¼‰
- âœ… å½©è‰²è¾“å‡ºï¼ˆsuccess/error/infoï¼‰

ä½¿ç”¨ç¤ºä¾‹ï¼š
    python -m my_cli --ui shell
"""

from __future__ import annotations

import asyncio
import json
from pathlib import Path

from kosong.chat_provider import ChatProviderError
from kosong.message import ContentPart, TextPart, ToolCall
from kosong.tooling import ToolError, ToolOk, ToolResult
from prompt_toolkit import PromptSession
from prompt_toolkit.history import InMemoryHistory
from rich.console import Console
from rich.panel import Panel
from rich.text import Text

from my_cli.soul import LLMNotSet, RunCancelled, create_soul, run_soul
from my_cli.wire import WireUISide
from my_cli.wire.message import StepBegin, StepInterrupted

__all__ = ["EnhancedShellUI"]

# Rich Consoleï¼ˆå…¨å±€å•ä¾‹ï¼‰
console = Console()


class EnhancedShellUI:
    """
    Enhanced Shell UI - å¢å¼ºç‰ˆäº¤äº’å¼ UIï¼ˆStage 10ï¼‰

    æ–°å¢ç‰¹æ€§ï¼š
    - âœ… prompt_toolkit PromptSessionï¼ˆå‘½ä»¤å†å²ã€ä¸Šä¸‹ç®­å¤´ï¼‰
    - âœ… rich Panel è¾¹æ¡†ï¼ˆæ¼‚äº®çš„æ¬¢è¿ä¿¡æ¯ï¼‰
    - âœ… æ–œæ å‘½ä»¤æ”¯æŒï¼ˆ/help, /clear, /exitï¼‰
    - âœ… å½©è‰²è¾“å‡ºï¼ˆæˆåŠŸ/é”™è¯¯/ä¿¡æ¯ï¼‰

    å¯¹åº”æºç ï¼škimi-cli-fork/src/kimi_cli/ui/shell/__init__.py
    """

    def __init__(self, verbose: bool = False, work_dir: Path | None = None):
        """
        åˆå§‹åŒ– Enhanced Shell UI

        Args:
            verbose: æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
            work_dir: å·¥ä½œç›®å½•ï¼ˆé»˜è®¤å½“å‰ç›®å½•ï¼‰
        """
        self.verbose = verbose
        self.work_dir = work_dir or Path.cwd()
        # Stage 10ï¼šå‘½ä»¤å†å²è®°å½• â­
        self.history = InMemoryHistory()

    async def run(self, command: str | None = None) -> None:
        """
        è¿è¡Œ Enhanced Shell UI

        Stage 10 å¢å¼ºï¼š
        - ä½¿ç”¨ prompt_toolkit PromptSession
        - ä½¿ç”¨ rich Console ç¾åŒ–è¾“å‡º
        - æ”¯æŒæ–œæ å‘½ä»¤
        """
        # 1. åˆ›å»º Soul
        try:
            soul = create_soul(work_dir=self.work_dir)
        except FileNotFoundError as e:
            console.print(f"\n[red]âŒ é…ç½®æ–‡ä»¶é”™è¯¯: {e}[/red]\n")
            console.print("è¯·å…ˆè¿è¡Œ 'mycli init' åˆ›å»ºé…ç½®æ–‡ä»¶")
            return
        except ValueError as e:
            console.print(f"\n[red]âŒ é…ç½®é”™è¯¯: {e}[/red]\n")
            return

        if self.verbose:
            console.print(f"\n[cyan]ğŸ¤– ä½¿ç”¨æ¨¡å‹: {soul.model_name}[/cyan]\n")

        # å•å‘½ä»¤æ¨¡å¼
        if command is not None:
            await self._run_single_command(soul, command)
            return

        # ============================================================
        # Stage 10ï¼šäº¤äº’å¾ªç¯æ¨¡å¼ï¼ˆå¢å¼ºç‰ˆï¼‰â­
        # ============================================================

        # 2. æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯ï¼ˆrich Panelï¼‰â­
        self._print_welcome(soul.name, soul.model_name)

        # 3. åˆ›å»º PromptSessionï¼ˆæ”¯æŒå‘½ä»¤å†å²ï¼‰â­
        session: PromptSession = PromptSession(history=self.history)

        # 4. äº¤äº’å¾ªç¯
        while True:
            try:
                # ä½¿ç”¨ prompt_toolkit è·å–è¾“å…¥ â­
                user_input = await session.prompt_async("âœ¨ You: ")

                # å¤„ç†ç©ºè¾“å…¥
                if not user_input.strip():
                    continue

                # ============================================================
                # Stage 10ï¼šæ–œæ å‘½ä»¤æ”¯æŒ â­
                # ============================================================
                if user_input.startswith("/"):
                    should_exit = await self._handle_slash_command(user_input, soul)
                    if should_exit:
                        break
                    continue

                # å¤„ç†é€€å‡ºå‘½ä»¤
                if user_input.lower() in ["exit", "quit", "q"]:
                    console.print("\n[yellow]ğŸ‘‹ å†è§ï¼[/yellow]\n")
                    break

                # è¿è¡Œ Soul
                await self._run_soul_command(soul, user_input)

            except KeyboardInterrupt:
                # Ctrl+Cï¼šå–æ¶ˆå½“å‰è¯·æ±‚ï¼Œç»§ç»­å¾ªç¯
                console.print("\n\n[grey50]âš ï¸  æç¤º: è¾“å…¥ 'exit' æˆ–æŒ‰ Ctrl+D é€€å‡º[/grey50]\n")
                continue

            except EOFError:
                # Ctrl+Dï¼šä¼˜é›…é€€å‡º
                console.print("\n\n[yellow]ğŸ‘‹ å†è§ï¼[/yellow]\n")
                break

            except Exception as e:
                # å…¶ä»–é”™è¯¯ï¼šæ‰“å°é”™è¯¯ä½†ç»§ç»­å¾ªç¯
                console.print(f"\n[red]âŒ æœªçŸ¥é”™è¯¯: {e}[/red]\n")
                if self.verbose:
                    import traceback
                    traceback.print_exc()
                continue

    async def _handle_slash_command(self, command: str, soul) -> bool:
        """
        å¤„ç†æ–œæ å‘½ä»¤ â­ Stage 10 æ–°å¢

        æ”¯æŒçš„å‘½ä»¤ï¼š
        - /help: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
        - /clear: æ¸…ç©º Context
        - /exit: é€€å‡ºç¨‹åº

        Args:
            command: æ–œæ å‘½ä»¤ï¼ˆå¦‚ "/help"ï¼‰
            soul: Soul å®ä¾‹

        Returns:
            æ˜¯å¦åº”è¯¥é€€å‡ºç¨‹åº
        """
        cmd = command.lower().strip()

        if cmd in ["/help", "/h", "/?"]:
            # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
            help_text = """
[bold cyan]ğŸ“š å¯ç”¨å‘½ä»¤ï¼š[/bold cyan]

[bold]åŸºç¡€å‘½ä»¤ï¼š[/bold]
  exit, quit         é€€å‡ºç¨‹åº
  Ctrl+D             é€€å‡ºç¨‹åº
  Ctrl+C             å–æ¶ˆå½“å‰è¯·æ±‚

[bold]æ–œæ å‘½ä»¤ï¼š[/bold]
  /help, /h, /?      æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
  /clear, /c         æ¸…ç©ºå¯¹è¯å†å²ï¼ˆContextï¼‰
  /exit, /quit       é€€å‡ºç¨‹åº

[bold]åŠŸèƒ½ï¼š[/bold]
  - å¤šè½®å¯¹è¯ï¼ˆè‡ªåŠ¨ä¿æŒ Contextï¼‰
  - å·¥å…·è°ƒç”¨ï¼ˆBashã€ReadFileã€WriteFileï¼‰
  - å‘½ä»¤å†å²ï¼ˆä¸Šä¸‹ç®­å¤´æŸ¥çœ‹å†å²è¾“å…¥ï¼‰
  - æµå¼è¾“å‡ºï¼ˆå®æ—¶æ˜¾ç¤º LLM å“åº”ï¼‰

[grey50]æç¤ºï¼šç›´æ¥è¾“å…¥é—®é¢˜å³å¯å¼€å§‹å¯¹è¯[/grey50]
"""
            console.print(Panel(help_text, border_style="cyan", padding=(1, 2)))
            return False

        elif cmd in ["/clear", "/c"]:
            # æ¸…ç©º Context
            # TODO: å®ç° Context.clear() æ–¹æ³•
            console.print("[yellow]âš ï¸  /clear å‘½ä»¤æš‚æœªå®ç°ï¼ˆéœ€è¦ Context.clear() æ–¹æ³•ï¼‰[/yellow]")
            console.print("[grey50]æç¤ºï¼šé‡å¯ç¨‹åºå¯æ¸…ç©ºå†å²[/grey50]")
            return False

        elif cmd in ["/exit", "/quit"]:
            # é€€å‡ºç¨‹åº
            console.print("\n[yellow]ğŸ‘‹ å†è§ï¼[/yellow]\n")
            return True

        else:
            # æœªçŸ¥å‘½ä»¤
            console.print(f"[red]âŒ æœªçŸ¥å‘½ä»¤: {command}[/red]")
            console.print("[grey50]è¾“å…¥ /help æŸ¥çœ‹å¯ç”¨å‘½ä»¤[/grey50]")
            return False

    async def _run_single_command(self, soul, command: str) -> None:
        """å•å‘½ä»¤æ¨¡å¼ï¼šæ‰§è¡Œä¸€æ¬¡å‘½ä»¤åé€€å‡º"""
        if self.verbose:
            console.print(f"[grey50]ğŸ“ ç”¨æˆ·è¾“å…¥: {command}[/grey50]\n")

        console.print("\n[bold cyan]ğŸ’¬ AI å›å¤:[/bold cyan]\n")
        try:
            await self._run_soul_command(soul, command)
            console.print("\n")

            if self.verbose:
                console.print(f"\n[green]âœ… å¯¹è¯è½®æ¬¡: {soul.message_count}[/green]")

        except Exception as e:
            console.print(f"\n[red]âŒ é”™è¯¯: {e}[/red]\n")
            raise

    async def _run_soul_command(self, soul, user_input: str) -> None:
        """è¿è¡Œ Soul å‘½ä»¤ï¼ˆæ ¸å¿ƒæ‰§è¡Œé€»è¾‘ï¼‰"""
        cancel_event = asyncio.Event()

        try:
            await run_soul(
                soul=soul,
                user_input=user_input,
                ui_loop_fn=self._ui_loop,
                cancel_event=cancel_event,
            )

        except LLMNotSet:
            console.print("\n[red]âŒ LLM æœªè®¾ç½®ï¼ˆéœ€è¦é…ç½® API Keyï¼‰[/red]\n")
        except ChatProviderError as e:
            console.print(f"\n[red]âŒ LLM API é”™è¯¯: {e}[/red]\n")
        except RunCancelled:
            pass
        except Exception as e:
            console.print(f"\n[red]âŒ æœªçŸ¥é”™è¯¯: {e}[/red]\n")
            raise

    async def _ui_loop(self, wire_ui: WireUISide) -> None:
        """
        UI Loop å‡½æ•° - ä» Wire æ¥æ”¶æ¶ˆæ¯å¹¶æ‰“å°

        Stage 10 å¢å¼ºï¼šä½¿ç”¨ rich console è¾“å‡ºå½©è‰²ä¿¡æ¯
        """
        while True:
            msg = await wire_ui.receive()

            # æ–‡æœ¬ç‰‡æ®µï¼šå®æ—¶æ‰“å°
            if isinstance(msg, TextPart):
                if msg.text:
                    console.print(msg.text, end="", markup=False)

            elif isinstance(msg, ContentPart):
                if hasattr(msg, "text") and msg.text:
                    console.print(msg.text, end="", markup=False)

            # æ­¥éª¤å¼€å§‹ï¼šæ˜¾ç¤ºæ­¥éª¤ç¼–å·
            elif isinstance(msg, StepBegin):
                if msg.n > 1:
                    console.print(f"\n\n[cyan]ğŸ”„ [Step {msg.n}][/cyan]")

            # å·¥å…·è°ƒç”¨ï¼šæ˜¾ç¤ºå·¥å…·åç§°å’Œå‚æ•°
            elif isinstance(msg, ToolCall):
                console.print(f"\n\n[yellow]ğŸ”§ è°ƒç”¨å·¥å…·: {msg.function.name}[/yellow]")
                try:
                    arguments = json.loads(msg.function.arguments) if msg.function.arguments else {}
                    args_str = json.dumps(arguments, ensure_ascii=False, indent=2)
                    console.print(f"[grey50]   å‚æ•°:\n{args_str}[/grey50]")
                except Exception:
                    console.print(f"[grey50]   å‚æ•°: {msg.function.arguments}[/grey50]")

            # å·¥å…·ç»“æœï¼šæ˜¾ç¤ºæˆåŠŸ/å¤±è´¥çŠ¶æ€
            elif isinstance(msg, ToolResult):
                if isinstance(msg.result, ToolOk):
                    console.print(f"\n[green]âœ… å·¥å…·æˆåŠŸ[/green]")
                    if msg.result.brief:
                        console.print(f"[grey50]   {msg.result.brief}[/grey50]")
                    output = str(msg.result.output)
                    if len(output) > 500:
                        output = output[:500] + "...(æˆªæ–­)"
                    if output.strip():
                        console.print(f"[grey50]   è¾“å‡º: {output}[/grey50]")
                elif isinstance(msg.result, ToolError):
                    console.print(f"\n[red]âŒ å·¥å…·å¤±è´¥: {msg.result.brief}[/red]")
                    if msg.result.message:
                        console.print(f"[grey50]   é”™è¯¯: {msg.result.message}[/grey50]")

            # æ­¥éª¤ä¸­æ–­ï¼šé€€å‡º UI Loop
            elif isinstance(msg, StepInterrupted):
                break

    def _print_welcome(self, name: str, model: str) -> None:
        """
        æ‰“å°æ¬¢è¿ä¿¡æ¯ â­ Stage 10 rich ç¾åŒ–ç‰ˆ

        ä½¿ç”¨ rich Panel è¾¹æ¡†å’Œé¢œè‰²
        """
        # æ„é€ æ¬¢è¿æ–‡æœ¬
        welcome_text = f"""[bold cyan]æ¬¢è¿ä½¿ç”¨ {name}![/bold cyan]

[grey50]æ¨¡å‹:[/grey50] [yellow]{model}[/yellow]
[grey50]è¾“å…¥ [/grey50][cyan]/help[/cyan][grey50] æŸ¥çœ‹å¯ç”¨å‘½ä»¤[/grey50]
[grey50]è¾“å…¥ [/grey50][cyan]exit[/cyan][grey50] æˆ–æŒ‰ [/grey50][cyan]Ctrl+D[/cyan][grey50] é€€å‡º[/grey50]
[grey50]æŒ‰ [/grey50][cyan]Ctrl+C[/cyan][grey50] å¯ä»¥å–æ¶ˆå½“å‰è¯·æ±‚[/grey50]
"""

        # ä½¿ç”¨ rich Panel æ˜¾ç¤º
        console.print(Panel(
            welcome_text,
            border_style="cyan",
            padding=(1, 2),
            expand=False,
        ))
        console.print()  # ç©ºè¡Œ


# ============================================================
# TODO: Stage 11+ æ›´å¤šå¢å¼ºï¼ˆå‚è€ƒå®˜æ–¹ï¼‰
# ============================================================
# å®˜æ–¹å‚è€ƒï¼škimi-cli-fork/src/kimi_cli/ui/shell/
#
# Stage 11+ éœ€è¦æ·»åŠ çš„åŠŸèƒ½ï¼š
#
# 1. CustomPromptSessionï¼ˆå®Œæ•´ç‰ˆï¼‰ï¼š
#    - è‡ªåŠ¨è¡¥å…¨ï¼ˆTab é”®ï¼‰
#    - å¤šè¡Œè¾“å…¥ï¼ˆShift+Enterï¼‰
#    - è‡ªå®šä¹‰é”®ç»‘å®š
#    - çŠ¶æ€æ æ˜¾ç¤º
#
# 2. æ›´å¤šæ–œæ å‘½ä»¤ï¼š
#    - /setup: é…ç½® LLM
#    - /thinking: å¯ç”¨æ€è€ƒæ¨¡å¼
#    - /yolo: YOLO æ¨¡å¼ï¼ˆè‡ªåŠ¨æ‰¹å‡†å·¥å…·ï¼‰
#    - /shell: æ‰§è¡Œ Shell å‘½ä»¤
#
# 3. Logo æ˜¾ç¤ºï¼š
#    - ASCII art logo
#    - ç‰ˆæœ¬æ›´æ–°æç¤º
#
# 4. ä¿¡å·å¤„ç†å¢å¼ºï¼š
#    - install_sigint_handler()
#    - å–æ¶ˆäº‹ä»¶ä¼ é€’
#
# 5. åå°ä»»åŠ¡ï¼š
#    - è‡ªåŠ¨æ›´æ–°æ£€æŸ¥
#    - å¼‚æ­¥ä»»åŠ¡ç®¡ç†
# ============================================================
